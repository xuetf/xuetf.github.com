<!doctype html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  

  

  
    

    
  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="神经网络,深度学习," />





  <link rel="alternate" href="/atom.xml" title="蘑菇先生学习记" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="本文将介绍使用Python书写“卷积神经网络”代码的具体步骤和细节，本文会采用Python开源库Theano，Theano封装了卷积等操作，使用起来比较方便。具体代码可参考神经网络和深度学习教程。在本文中，卷积神经网络对MNIST手写数字的预测性能，测试集准确率可以达到99.30%。">
<meta property="og:type" content="article">
<meta property="og:title" content="卷积神经网络实践">
<meta property="og:url" content="xtf615.com/2017/08/17/cnn-written/index.html">
<meta property="og:site_name" content="蘑菇先生学习记">
<meta property="og:description" content="本文将介绍使用Python书写“卷积神经网络”代码的具体步骤和细节，本文会采用Python开源库Theano，Theano封装了卷积等操作，使用起来比较方便。具体代码可参考神经网络和深度学习教程。在本文中，卷积神经网络对MNIST手写数字的预测性能，测试集准确率可以达到99.30%。">
<meta property="og:image" content="xtf615.com/picture/machine-learning/cnn1.png">
<meta property="og:image" content="xtf615.com/picture/machine-learning/cnn2.png">
<meta property="og:image" content="xtf615.com/picture/machine-learning/cnn3.png">
<meta property="og:image" content="xtf615.com/picture/machine-learning/cnn4.png">
<meta property="og:image" content="xtf615.com/picture/machine-learning/cnn_error_digits.png">
<meta property="og:image" content="xtf615.com/picture/machine-learning/cnn_error_digits_double_conv.png">
<meta property="og:updated_time" content="2017-08-22T13:47:00.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="卷积神经网络实践">
<meta name="twitter:description" content="本文将介绍使用Python书写“卷积神经网络”代码的具体步骤和细节，本文会采用Python开源库Theano，Theano封装了卷积等操作，使用起来比较方便。具体代码可参考神经网络和深度学习教程。在本文中，卷积神经网络对MNIST手写数字的预测性能，测试集准确率可以达到99.30%。">
<meta name="twitter:image" content="xtf615.com/picture/machine-learning/cnn1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="xtf615.com/2017/08/17/cnn-written/"/>





  <title> 卷积神经网络实践 | 蘑菇先生学习记 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">蘑菇先生学习记</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <p class="site-subtitle"></p>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="st-search-show-outputs">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <form class="site-search-form">
  <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
</form>

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'WgLy48WeXh1aXsWx1x7L','2.0.0');
</script>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="xtf615.com/2017/08/17/cnn-written/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="xuetf">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/11912425?v=3&u=11f9f5dc75aaf84f020a06c0b9cb2b6f401c586b&s=400">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="蘑菇先生学习记">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="蘑菇先生学习记" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                卷积神经网络实践
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-08-17T09:35:34+08:00">
                2017-08-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/深度学习/" itemprop="url" rel="index">
                    <span itemprop="name">深度学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i> 阅读量 
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>　　本文将介绍使用Python书写“卷积神经网络”代码的具体步骤和细节，本文会采用Python开源库Theano，Theano封装了卷积等操作，使用起来比较方便。具体代码可参考<a href="http://neuralnetworksanddeeplearning.com/chap6.html" target="_blank" rel="external">神经网络和深度学习教程</a>。在本文中，卷积神经网络对MNIST手写数字的预测性能，测试集准确率可以达到99.30%。<br><a id="more"></a></p>
<h1 id="Theano安装"><a href="#Theano安装" class="headerlink" title="Theano安装"></a>Theano安装</h1><h2 id="Anaconda"><a href="#Anaconda" class="headerlink" title="Anaconda"></a>Anaconda</h2><p>　　Theano依赖于numpy等库，故首先安装集成包Anaconda，这个软件内嵌了python，并且还包含了很多用于计算的库。本文使用的是4.3.24版本，内置python为2.7.13版本。下载地址为：<a href="https://www.continuum.io/downloads" target="_blank" rel="external">https://www.continuum.io/downloads</a></p>
<h2 id="MinGW"><a href="#MinGW" class="headerlink" title="MinGW"></a>MinGW</h2><p>　　Theano底层依赖于C编译器。一种方式是，在控制台输入conda install mingw libpython即可。注意libpython也必须要安装，否则后面导入theano后会报“no module named gof”的错误。另一种也可以手动去MinGW安装包安装，但libpython仍然需要安装。</p>
<h2 id="Theano"><a href="#Theano" class="headerlink" title="Theano"></a>Theano</h2><p>　　最后安装Theano，使用pip install theano即可。</p>
<h1 id="数据集加载"><a href="#数据集加载" class="headerlink" title="数据集加载"></a>数据集加载</h1><p>　　本文使用的数据集同样是来自MNIST手写数字库。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span>  <span class="title">load_data_shared</span><span class="params">(filename=<span class="string">"../data/mnist.pkl.gz"</span>)</span>:</span></div><div class="line">    f = gzip.open(filename, <span class="string">'rb'</span>)</div><div class="line">    training_data, validation_data, test_data = cPickle.load(f)</div><div class="line">    f.close()</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">shared</span><span class="params">(data)</span>:</span></div><div class="line">        shared_x = theano.shared(</div><div class="line">            np.asarray(data[<span class="number">0</span>], dtype=theano.config.floatX), borrow=<span class="keyword">True</span>)</div><div class="line">        shared_y = theano.shared(</div><div class="line">            np.asarray(data[<span class="number">1</span>], dtype=theano.config.floatX), borrow=<span class="keyword">True</span>)</div><div class="line">        <span class="keyword">return</span> shared_x, T.cast(shared_y, <span class="string">"int32"</span>)</div><div class="line">    <span class="keyword">return</span> [shared(training_data), shared(validation_data), shared(test_data)]</div></pre></td></tr></table></figure></p>
<p>　　这里使用了theano的shared变量，shared变量意味着shared_x和shared_y可以在不同的函数中共享。在使用GPU时，Theano能够很方便的拷贝数据到不同的GPU中。borrow=True代表了浅拷贝。</p>
<h1 id="卷积神经网络结构"><a href="#卷积神经网络结构" class="headerlink" title="卷积神经网络结构"></a>卷积神经网络结构</h1><p>　　本文采取的神经网络结构如下:<br><img src="/picture/machine-learning/cnn1.png" alt="cnn"><br>　　输入层是5万条手写数字图像，每条数据是28*28的像素矩阵。然后在右边插入一个卷积层，使用5*5的局部感受野，跨距为1，20个特征映射对输入层进行特征提取。因此得到20*(28-5+1)*(28-5+1)=20*24*24规格的卷积层，这意味着每一副图像经过特征映射后都会得到20副24*24的卷积结果图像。接着再插入一个最大值混合层，使用2*2的混合窗口来合并特征。因此得到规格为20*(24/2)*(24/2)=20*12*12规格的混合层。紧接着再插入一个全连接层，有100个神经元。最后是输出层，和全连接层采用全连接的方式，这里使用柔性最大值来求得激活值。</p>
<h1 id="运行代码"><a href="#运行代码" class="headerlink" title="运行代码"></a>运行代码</h1><p>　　让我们先总体看一下最终运行的代码：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">training_data,validation_data,test_data=load_data_shared()</div><div class="line">mini_batch_size= <span class="number">10</span></div><div class="line">net2 = Network([ConvPoolLayer(image_shape=(mini_batch_size,<span class="number">1</span>,<span class="number">28</span>,<span class="number">28</span>),filter_shape=(<span class="number">20</span>,<span class="number">1</span>,<span class="number">5</span>,<span class="number">5</span>),poolsize=(<span class="number">2</span>,<span class="number">2</span>)),</div><div class="line">               FullyConnectedLayer(n_in=<span class="number">20</span>*<span class="number">12</span>*<span class="number">12</span>,n_out=<span class="number">100</span>),SoftmaxLayer(n_in=<span class="number">100</span>,n_out=<span class="number">10</span>)],mini_batch_size)</div><div class="line">net2.SGD(training_data,<span class="number">60</span>,mini_batch_size,<span class="number">0.1</span>,validation_data,test_data)</div></pre></td></tr></table></figure></p>
<p>　　可以看到运行的代码包括加载数据集、构建神经网络结构、运行学习算法SGD。下面将介绍不同层的代码细节。</p>
<h1 id="卷积层和混合层"><a href="#卷积层和混合层" class="headerlink" title="卷积层和混合层"></a>卷积层和混合层</h1><p>　　下面将描述运行代码中的细节。首先介绍卷积层和混合层的代码。这里面将卷积层和混合层统一封装，使得代码更加紧凑。首先看一下代码：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConvPoolLayer</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="string">"""Used to create a combination of a convolutional and a max-pooling</span></div><div class="line">    layer.  A more sophisticated implementation would separate the</div><div class="line">    two, but for our purposes we'll always use them together, and it</div><div class="line">    simplifies the code, so it makes sense to combine them.</div><div class="line">    """</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, filter_shape, image_shape, poolsize=<span class="params">(<span class="number">2</span>, <span class="number">2</span>)</span>,</span></span></div><div class="line">                 activation_fn=sigmoid):</div><div class="line">        <span class="string">"""`filter_shape` is a tuple of length 4, whose entries are the number</span></div><div class="line">        of filters, the number of input feature maps, the filter height, and the</div><div class="line">        filter width.</div><div class="line"></div><div class="line">        `image_shape` is a tuple of length 4, whose entries are the</div><div class="line">        mini-batch size, the number of input feature maps, the image</div><div class="line">        height, and the image width.</div><div class="line"></div><div class="line">        `poolsize` is a tuple of length 2, whose entries are the y and</div><div class="line">        x pooling sizes.</div><div class="line"></div><div class="line">        """</div><div class="line">        self.filter_shape = filter_shape</div><div class="line">        self.image_shape = image_shape</div><div class="line">        self.poolsize = poolsize</div><div class="line">        self.activation_fn=activation_fn</div><div class="line">        <span class="comment"># initialize weights and biases</span></div><div class="line">        n_out = (filter_shape[<span class="number">0</span>]*np.prod(filter_shape[<span class="number">2</span>:])/np.prod(poolsize))</div><div class="line">        self.w = theano.shared(</div><div class="line">            np.asarray(</div><div class="line">                np.random.normal(loc=<span class="number">0</span>, scale=np.sqrt(<span class="number">1.0</span>/n_out), size=filter_shape),</div><div class="line">                dtype=theano.config.floatX),</div><div class="line">            borrow=<span class="keyword">True</span>)</div><div class="line">        self.b = theano.shared(</div><div class="line">            np.asarray(</div><div class="line">                np.random.normal(loc=<span class="number">0</span>, scale=<span class="number">1.0</span>, size=(filter_shape[<span class="number">0</span>],)),</div><div class="line">                dtype=theano.config.floatX),</div><div class="line">            borrow=<span class="keyword">True</span>)</div><div class="line">        self.params = [self.w, self.b]</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_inpt</span><span class="params">(self, inpt, inpt_dropout, mini_batch_size)</span>:</span></div><div class="line">        self.inpt = inpt.reshape(self.image_shape)</div><div class="line">        conv_out = conv.conv2d(</div><div class="line">            input=self.inpt, filters=self.w, filter_shape=self.filter_shape,</div><div class="line">            image_shape=self.image_shape)</div><div class="line">        pooled_out = pool.pool_2d(</div><div class="line">            input=conv_out, ds=self.poolsize, ignore_border=<span class="keyword">True</span>)</div><div class="line">        self.output = self.activation_fn(</div><div class="line">            pooled_out + self.b.dimshuffle(<span class="string">'x'</span>, <span class="number">0</span>, <span class="string">'x'</span>, <span class="string">'x'</span>))</div><div class="line">        self.output_dropout = self.output <span class="comment"># no dropout in the convolutional layers</span></div></pre></td></tr></table></figure></p>
<h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化　　"></a>初始化　　</h2><p>　　首先看一下初始化方法。其中参数filter_shape是一个四元组，由卷积核(filter)个数、输入特征集(input feature maps)个数、卷积核行数、卷积核的列数构成。这里的滤波器个数对应的是前面图中的20，也就是使用20个卷积核进行特征提取。行数和列数大小也就是局部感受野的大小。而输入特征集个数代表的是输入数据，例如一般图都有3个通道Channel，每个图初始有3张feature map(R,G,B)，对于一张图，其所有feature map用一个filter卷成一张feature map。用20个filter，则卷成20张feature map。本文的数据使用的是手写图像的灰度值，因此只有1个feature map。image_shape参数也是一个四元组，由随机梯度下降选择的样本量mini_batch_size，输入特征集个数，每张图的宽度和高度构成。poolsize是卷积层到混合层使用的混合窗口大小。<br>　　首先进行参数的保存，前面的层使用的是sigmoid激活函数。n_out在初始化权重的时候指定方差使用，在本文中n_out=125,具体该数值含义目前不是非常理解。np.random.normal(loc=0, scale=np.sqrt(1.0/n_out), size=filter_shape使用高斯分布初始化了一个四维数组，规格为(20L,1L,5L,5L),由于一个特征映射有5*5=25个参数，则20个特征映射<br>就有500个权重参数。np.random.normal(loc=0, scale=1.0, size=(filter_shape<a href="http://neuralnetworksanddeeplearning.com/chap6.html" target="_blank" rel="external">0</a>,))初始化偏置值，每个特征映射只需要对应1个偏置，20个特征映射需要20个偏置即可。可以看出这里的参数个数总共有520个。如果不使用共享权重的方式，而是使用全连接的话，若隐藏层有30个神经元，则有784*30+30=23550个参数，几乎比卷积层多了40倍的参数。使用shared变量包装w和b后，w就是一个TensorType<float64,4d>类型的变量,b是一个TensorType<float64,vector>变量。</float64,vector></float64,4d></p>
<h2 id="卷积操作"><a href="#卷积操作" class="headerlink" title="卷积操作"></a>卷积操作</h2><p>　　set_inpt方法会根据参数来计算当前层的输出。参数inpt是前一层的输出，参数inpt_dropout是经过弃权策略后的前一层的输出。self.inpt = inpt.reshape(self.image_shape)将输入数据按照(10L,1L,28L,28L)的规格进行重塑。10代表每个小批量有10条数据，1L代表只有1个输入特征集，28*28则代表图像的大小。<br>　　接着是卷积操作：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">conv_out = conv.conv2d(input=self.inpt, filters=self.w, filter_shape=self.filter_shape,image_shape=self.image_shape)</div></pre></td></tr></table></figure></p>
<p>　　使用的是theano.tensor.nnet.conv封装好的conv2d卷积操作方法。对于该方法的理解，下面通过一个例子来理解。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line"><span class="keyword">import</span> theano</div><div class="line"><span class="keyword">import</span> theano.tensor <span class="keyword">as</span> T</div><div class="line"><span class="keyword">from</span> theano <span class="keyword">import</span> function</div><div class="line"><span class="keyword">from</span> theano.tensor.nnet.conv <span class="keyword">import</span> conv2d</div><div class="line"></div><div class="line">inputs = T.tensor4(name=<span class="string">'input'</span>, dtype=<span class="string">'float64'</span>)<span class="comment">#输入时一个4维向量，[图片数量，RGB通道数，图片行数，图片列数]</span></div><div class="line"></div><div class="line"><span class="comment">#w_shp = (2, 2, 1, 2) # [卷积核数量，输入特征通道数，卷积核行数，卷积核列数]</span></div><div class="line">W = theano.shared(</div><div class="line">    np.asarray(</div><div class="line">        [</div><div class="line">            [[[<span class="number">1.</span>, <span class="number">1.</span>]],</div><div class="line">             [[<span class="number">1.</span>, <span class="number">1.</span>]]],</div><div class="line">            [[[<span class="number">2.</span>, <span class="number">2.</span>]],</div><div class="line">             [[<span class="number">1.</span>, <span class="number">1.</span>]]]</div><div class="line">        ],</div><div class="line">        dtype=inputs.dtype),</div><div class="line">    name=<span class="string">'W'</span>)<span class="comment">#第一维代表卷积核，第二维对应通道，每种通道都有相对应的权重</span></div><div class="line"></div><div class="line">conv_out = conv2d(inputs, W)<span class="comment"># 卷积操作</span></div><div class="line"></div><div class="line">f = theano.function([inputs], conv_out)</div><div class="line"></div><div class="line"><span class="comment">#img_shp = [1,2,1,5] #[多少张图片，RGB通道数，图片行数，图片列数]</span></div><div class="line">i = np.asarray([</div><div class="line">    [[[<span class="number">1.</span>, <span class="number">2.</span>, <span class="number">3.</span>, <span class="number">4.</span>, <span class="number">5.</span>]],</div><div class="line">     [[<span class="number">1.</span>, <span class="number">2.</span>, <span class="number">3.</span>, <span class="number">4.</span>, <span class="number">5.</span>]]]</div><div class="line">], dtype=<span class="string">'float64'</span>) <span class="comment">#只输入1张图片</span></div><div class="line">ii = f(i)</div><div class="line">print(i.shape)</div><div class="line">print(W.get_value().shape)</div><div class="line">print(ii)</div><div class="line">print(ii.shape)</div><div class="line"></div><div class="line"><span class="comment"># out result:</span></div><div class="line">(<span class="number">1L</span>, <span class="number">2L</span>, <span class="number">1L</span>, <span class="number">5L</span>)</div><div class="line">(<span class="number">2L</span>, <span class="number">2L</span>, <span class="number">1L</span>, <span class="number">2L</span>)</div><div class="line">[[[[  <span class="number">6.</span>  <span class="number">10.</span>  <span class="number">14.</span>  <span class="number">18.</span>]]</div><div class="line"></div><div class="line">  [[  <span class="number">9.</span>  <span class="number">15.</span>  <span class="number">21.</span>  <span class="number">27.</span>]]]]</div><div class="line">(<span class="number">1L</span>, <span class="number">2L</span>, <span class="number">1L</span>, <span class="number">4L</span>)</div></pre></td></tr></table></figure></p>
<p>　　上述使用两个卷积核，因此对于每幅图，有两个输出。对于第一个卷积结果[  6.  10.  14.  18.]，是如下计算得到的：<br>　　利用第一个卷积核前半部分[1,1]扫描第一个通道数据，根据线性组合\(wx+b\)，得到[1*1+1*2,1*2+1*3,1*3+1*4,1*4+1*5]=[3,5,7,9]；同理利用第一个卷积核后半部分[1,1]扫描得到[3,5,7,9];两个向量相加得到[6.  10.  14.  18.]<br>　　同样，对于第二个卷积结果[  9.  15.  21.  27.]。利用第二个卷积核扫描两个通道的数据，再相加即可得到。</p>
<h2 id="池化操作"><a href="#池化操作" class="headerlink" title="池化操作"></a>池化操作</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">pooled_out = pool.pool_2d(</div><div class="line">            input=conv_out, ds=self.poolsize, ignore_border=<span class="keyword">True</span>,mode=<span class="string">'max'</span>)</div></pre></td></tr></table></figure>
<p>　　对卷积结果进行池化。这里使用的是最大池化(混合)方法。使用poolsize大小的窗口扫描卷积后的结果，取poolsize范围内的最大值作为结果。我们可以把最大值混合看作一种网络询问是否有一个给定的特征在一个图像区域中。然后扔掉确切的位置信息。直观上，一旦一个特征被发现，它的确切位置并不如它相对于其它特征的位置重要。同时这有助于减少在以后的层所需的参数的数目。</p>
<h2 id="激活操作"><a href="#激活操作" class="headerlink" title="激活操作　"></a>激活操作　</h2><p>　　接着使用激活函数来求得输出。由于池化后的结果仍然是四维的TensorType<float64,4d>，b的结构是TensorType<float64,vector>,因此我们需要调整b的结构为4维。这里使用dimshuffle，它是用来改变一个数组张量结构的一个工具，我们需要利用这个工具将b张成4维结构。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">self.output = self.activation_fn(</div><div class="line">            pooled_out + self.b.dimshuffle(<span class="string">'x'</span>, <span class="number">0</span>, <span class="string">'x'</span>, <span class="string">'x'</span>))</div></pre></td></tr></table></figure></float64,vector></float64,4d></p>
<p>　　上式dimshuffle的参数可以’0，1或’x’。0代表原始的行数，1代表原始的列数，x代表增加1维。因此张量后的b为(1L,20L,1L,1L)。</p>
<h1 id="全连接层"><a href="#全连接层" class="headerlink" title="全连接层"></a>全连接层</h1><p>　　全连接层和之前讨论前馈神经网络中的隐藏层类似。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">FullyConnectedLayer</span><span class="params">(object)</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, n_in, n_out, activation_fn=sigmoid, p_dropout=<span class="number">0.0</span>)</span>:</span></div><div class="line">        self.n_in = n_in</div><div class="line">        self.n_out = n_out</div><div class="line">        self.activation_fn = activation_fn</div><div class="line">        self.p_dropout = p_dropout</div><div class="line">        <span class="comment"># Initialize weights and biases</span></div><div class="line">        self.w = theano.shared(</div><div class="line">            np.asarray(</div><div class="line">                np.random.normal(</div><div class="line">                    loc=<span class="number">0.0</span>, scale=np.sqrt(<span class="number">1.0</span>/n_out), size=(n_in, n_out)),</div><div class="line">                dtype=theano.config.floatX),</div><div class="line">            name=<span class="string">'w'</span>, borrow=<span class="keyword">True</span>)</div><div class="line">        self.b = theano.shared(</div><div class="line">            np.asarray(np.random.normal(loc=<span class="number">0.0</span>, scale=<span class="number">1.0</span>, size=(n_out,)),</div><div class="line">                       dtype=theano.config.floatX),</div><div class="line">            name=<span class="string">'b'</span>, borrow=<span class="keyword">True</span>)</div><div class="line">        self.params = [self.w, self.b]</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_inpt</span><span class="params">(self, inpt, inpt_dropout, mini_batch_size)</span>:</span></div><div class="line">        self.inpt = inpt.reshape((mini_batch_size, self.n_in))</div><div class="line">        self.output = self.activation_fn(</div><div class="line">            (<span class="number">1</span>-self.p_dropout)*T.dot(self.inpt, self.w) + self.b)</div><div class="line">        self.y_out = T.argmax(self.output, axis=<span class="number">1</span>)</div><div class="line">        self.inpt_dropout = dropout_layer(</div><div class="line">            inpt_dropout.reshape((mini_batch_size, self.n_in)), self.p_dropout)</div><div class="line">        self.output_dropout = self.activation_fn(</div><div class="line">            T.dot(self.inpt_dropout, self.w) + self.b)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">accuracy</span><span class="params">(self, y)</span>:</span></div><div class="line">        <span class="string">"Return the accuracy for the mini-batch."</span></div><div class="line">        <span class="keyword">return</span> T.mean(T.eq(y, self.y_out))</div></pre></td></tr></table></figure></p>
<h2 id="初始化-1"><a href="#初始化-1" class="headerlink" title="初始化　"></a>初始化　</h2><p>　　初始化参数包括该层神经元个数和后一层神经元个数。该层神经元个数n_in=20*12*12=2880,下一层神经元个数n_out=100。因此共有2880*100+100=288100个参数。这里激活函数仍然使用sigmoid。p_dropout指定了弃权概率，是为了防止过拟合。</p>
<h2 id="dropout弃权"><a href="#dropout弃权" class="headerlink" title="dropout弃权"></a>dropout弃权</h2><p>　　首先按照(mini_batch_size, self.n_in)调整输入结构，再计算激活值，计算激活值时使用到了弃权策略。弃权策略是为了防止过拟合，对于神经网络单元，按照一定的概率将其暂时从网络中丢弃。注意是暂时，对于随机梯度下降来说，由于是随机丢弃，故而每一个mini-batch都在训练不同的网络。具体过程如下所示：<br><img src="/picture/machine-learning/cnn2.png" alt="cnn"><br>　　这是原始的结构。特别地，假设我们有一个训练数据x和对应的目标输出y。通常我们会通过在网络中前向传播x，然后进行反向传播来确定对梯度的贡献。使用弃权技术，这个过程就改了。我们会随机（临时）地删除网络中部分的隐藏神经元，输入层和输出层的神经元保持不变。在此之后，我们会得到最终如下线条所示的网络。注意那些被弃权的神经元，即那些临时被删除的神经元，用虚圈表示在图中：<br><img src="/picture/machine-learning/cnn3.png" alt="cnn"><br>　　具体关于dropout的理解可参考<a href="http://blog.csdn.net/stdcoutzyx/article/details/49022443" target="_blank" rel="external">理解dropout</a>。<br>　　代码中的self.output和self.output_dropout是有区别的。<br>　　self.output是在<strong>测试阶段</strong>使用的，计算时需要乘以(1-self.p_dropout)。即在网络前向传播到输出层前时隐含层节点的输出值都要缩减到（1-v）倍。例如正常的隐层输出为a，此时需要缩减为a（1-v）。这里我的解释是：假设比例v=0.5，即在训练阶段，以0.5的比例忽略隐层节点；那么假设隐层有80个节点，每个节点输出值为1，那么此时只有40个节点正常工作；也就是说总的输出为40个1和40个0；输出总和为40；而在测试阶段，由于我们的权值已经训练完成，此时就不在按照0.5的比例忽略隐层输出，假设此时每个隐层的输出还是1，那么此时总的输出为80个1，明显比dropout训练时输出大一倍（由于dropout比例为0.5）；所以为了得到和训练时一样的输出结果，就缩减隐层输出为a（1-v）；即此时输出80个0.5，总和也为40.这样就使得测试阶段和训练阶段的输出“一致”了。可参考<a href="/picture/machine-learning/cnn3.png">机器学习——Dropout原理介绍</a>中测试阶段一节。<br>　　而self.output_dropout是在<strong>训练阶段</strong>使用的。self.output_dropout的计算是根据上述dropout定义来做的。使用伯努利分布生成掩码,来随机忽略部分神经元。公式参考如下：<br><img src="/picture/machine-learning/cnn4.png" alt="cnn"><br>　　具体代码如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">dropout_layer</span><span class="params">(layer, p_dropout)</span>:</span></div><div class="line">       srng = shared_randomstreams.RandomStreams(</div><div class="line">           np.random.RandomState(<span class="number">0</span>).randint(<span class="number">999999</span>))</div><div class="line">       mask = srng.binomial(n=<span class="number">1</span>, p=<span class="number">1</span>-p_dropout, size=layer.shape)</div><div class="line">       <span class="keyword">return</span> layer*T.cast(mask, theano.config.floatX)</div></pre></td></tr></table></figure></p>
<p>　　另外，还有一个问题，为什么只对全连接层应用弃权？<br>　　原则上我们可以在卷积层上应用一个类似的程序。但是，实际上那没必要：卷积层有相当大的先天的对于过度拟合的抵抗。原因是共享权重意味着卷积核被强制从整个图像中学习。这使他们不太可能去选择在训练数据中的局部特质。于是就很少有必要来应用其它规范化，例如弃权。</p>
<h1 id="输出层"><a href="#输出层" class="headerlink" title="输出层"></a>输出层</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SoftmaxLayer</span><span class="params">(object)</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, n_in, n_out, p_dropout=<span class="number">0.0</span>)</span>:</span></div><div class="line">        self.n_in = n_in</div><div class="line">        self.n_out = n_out</div><div class="line">        self.p_dropout = p_dropout</div><div class="line">        <span class="comment"># Initialize weights and biases</span></div><div class="line">        self.w = theano.shared(</div><div class="line">            np.zeros((n_in, n_out), dtype=theano.config.floatX),</div><div class="line">            name=<span class="string">'w'</span>, borrow=<span class="keyword">True</span>)</div><div class="line">        self.b = theano.shared(</div><div class="line">            np.zeros((n_out,), dtype=theano.config.floatX),</div><div class="line">            name=<span class="string">'b'</span>, borrow=<span class="keyword">True</span>)</div><div class="line">        self.params = [self.w, self.b]</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_inpt</span><span class="params">(self, inpt, inpt_dropout, mini_batch_size)</span>:</span></div><div class="line">        self.inpt = inpt.reshape((mini_batch_size, self.n_in))</div><div class="line">        self.output = softmax((<span class="number">1</span>-self.p_dropout)*T.dot(self.inpt, self.w) + self.b)</div><div class="line">        self.y_out = T.argmax(self.output, axis=<span class="number">1</span>)</div><div class="line">        self.inpt_dropout = dropout_layer(</div><div class="line">            inpt_dropout.reshape((mini_batch_size, self.n_in)), self.p_dropout)</div><div class="line">        self.output_dropout = softmax(T.dot(self.inpt_dropout, self.w) + self.b)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cost</span><span class="params">(self, net)</span>:</span></div><div class="line">        <span class="string">"Return the log-likelihood cost."</span></div><div class="line">        <span class="keyword">return</span> -T.mean(T.log(self.output_dropout)[T.arange(net.y.shape[<span class="number">0</span>]), net.y])</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">accuracy</span><span class="params">(self, y)</span>:</span></div><div class="line">        <span class="string">"Return the accuracy for the mini-batch."</span></div><div class="line">        <span class="keyword">return</span> T.mean(T.eq(y, self.y_out))</div></pre></td></tr></table></figure>
<p>　　输出层和全连接层大同小异。主要区别包括，使用softmax激活函数代替sigmoid以及使用对数似然代价函数代替交叉熵代价函数。</p>
<h2 id="柔性最大值"><a href="#柔性最大值" class="headerlink" title="柔性最大值"></a>柔性最大值</h2><p>　　柔性最大值公式如下：<br>$$a_j^L = \frac{e^{z_j^L}}{\sum_k e^{z_k^L}}$$<br>　　同时有：<br>$$\sum_j a_j^L = \frac{\sum_j e^{z_j^L}}{\sum_k e^{z_k^L}}=1$$<br>　　因此柔性最大值层的输出可以看作是一个概率分布。在MNIST分类问题中，可以将\(a_j^L\)理解为网络估计正确数字分类为\(j\)的概率。</p>
<h2 id="对数似然代价函数"><a href="#对数似然代价函数" class="headerlink" title="对数似然代价函数"></a>对数似然代价函数</h2><p>　　前面说到可以把柔性最大值的输出看作是一个概率分布，因此我们可以使用对数似然代价函数。根据：<br>$$\mathcal{L} (\theta=\{W,b\}, \mathcal{D}) = \sum_{i=0}^{|\mathcal{D}|} \log(P(Y=y^{(i)}|x^{(i)}, W,b)) \\\ \ell (\theta=\{W,b\}, \mathcal{D}) = - \mathcal{L} (\theta=\{W,b\}, \mathcal{D})$$<br>　　具体代码：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">loss = -T.mean(T.log(p_y_given_x)[T.arange(y.shape[<span class="number">0</span>]), y])</div><div class="line"><span class="comment"># note on syntax: T.arange(y.shape[0]) is a vector of integers [0,1,2,...,len(y)].</span></div><div class="line"><span class="comment"># Indexing a matrix M by the two vectors [0,1,...,K], [a,b,...,k] returns the</span></div><div class="line"><span class="comment"># elements M[0,a], M[1,b], ..., M[K,k] as a vector.  Here, we use this</span></div><div class="line"><span class="comment"># syntax to retrieve the log-probability of the correct labels, y.</span></div></pre></td></tr></table></figure></p>
<p>　　具体解释可参考上述注释部分。每次求得是一个mini-batch-size里的总代价。y的索引不一定是从0开始，因此使用[T.arange(y.shape[0]), y]来索引。<br>　　注意每次计算代价的时候，需要用到self.output_dropout，而self.output_dropout是在set_inpt定义的，cost和self.output_dropout都是预定义的符号运算，实际上每次计算代价时，都会进行前向传播计算出self.output_dropout。</p>
<h1 id="Network初始化"><a href="#Network初始化" class="headerlink" title="Network初始化"></a>Network初始化</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Network</span><span class="params">(object)</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, layers, mini_batch_size)</span>:</span></div><div class="line">        <span class="string">"""Takes a list of `layers`, describing the network architecture, and</span></div><div class="line">        a value for the `mini_batch_size` to be used during training</div><div class="line">        by stochastic gradient descent.</div><div class="line"></div><div class="line">        """</div><div class="line">        self.layers = layers</div><div class="line">        self.mini_batch_size = mini_batch_size</div><div class="line">        self.params = [param <span class="keyword">for</span> layer <span class="keyword">in</span> self.layers <span class="keyword">for</span> param <span class="keyword">in</span> layer.params]</div><div class="line">        self.x = T.matrix(<span class="string">"x"</span>)</div><div class="line">        self.y = T.ivector(<span class="string">"y"</span>)</div><div class="line">        init_layer = self.layers[<span class="number">0</span>]</div><div class="line">        init_layer.set_inpt(self.x, self.x, self.mini_batch_size)</div><div class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> xrange(<span class="number">1</span>, len(self.layers)):</div><div class="line">            prev_layer, layer  = self.layers[j<span class="number">-1</span>], self.layers[j]</div><div class="line">            layer.set_inpt(</div><div class="line">                prev_layer.output, prev_layer.output_dropout, self.mini_batch_size)</div><div class="line">        self.output = self.layers[<span class="number">-1</span>].output</div><div class="line">        self.output_dropout = self.layers[<span class="number">-1</span>].output_dropout</div></pre></td></tr></table></figure>
<p>　　self.x定义了数据的符号化矩阵，参数是名称；self.y定义了分类的符号化向量，参数同样是名称。接着定义符号化前向传播算法，来计算输出。<strong>实际上初始化的时候，没有代入具体实际数据来进行前向传播计算输出，而是定义了前向传播计算图，后面层的输入依赖于前面层的前向传播输出，这样后面计算某一层的输出时，直接调用该层的输出符号，即可自动根据计算图去计算出前面层的输出结果</strong>。</p>
<h1 id="学习算法"><a href="#学习算法" class="headerlink" title="学习算法"></a>学习算法</h1><p>　　最后，让我们关注下核心的学习算法SGD。这里面还会介绍theano符号化计算,Theano会将符号数学化计算表示成graph,之后实际运行时才开始真正的计算。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">SGD</span><span class="params">(self, training_data, epochs, mini_batch_size, eta,</span></span></div><div class="line">        validation_data, test_data, lmbda=<span class="number">0.0</span>):</div><div class="line">    <span class="string">"""Train the network using mini-batch stochastic gradient descent."""</span></div><div class="line">    training_x, training_y = training_data</div><div class="line">    validation_x, validation_y = validation_data</div><div class="line">    test_x, test_y = test_data</div><div class="line"></div><div class="line">    <span class="comment"># compute number of minibatches for training, validation and testing</span></div><div class="line">    num_training_batches = size(training_data)/mini_batch_size</div><div class="line">    num_validation_batches = size(validation_data)/mini_batch_size</div><div class="line">    num_test_batches = size(test_data)/mini_batch_size</div><div class="line"></div><div class="line">    <span class="comment"># define the (regularized) cost function, symbolic gradients, and updates</span></div><div class="line">    l2_norm_squared = sum([(layer.w**<span class="number">2</span>).sum() <span class="keyword">for</span> layer <span class="keyword">in</span> self.layers])</div><div class="line">    cost = self.layers[<span class="number">-1</span>].cost(self)+\</div><div class="line">           <span class="number">0.5</span>*lmbda*l2_norm_squared/num_training_batches</div><div class="line">    grads = T.grad(cost, self.params)</div><div class="line">    updates = [(param, param-eta*grad)</div><div class="line">               <span class="keyword">for</span> param, grad <span class="keyword">in</span> zip(self.params, grads)]</div><div class="line"></div><div class="line">    <span class="comment"># define functions to train a mini-batch, and to compute the</span></div><div class="line">    <span class="comment"># accuracy in validation and test mini-batches.</span></div><div class="line">    i = T.lscalar() <span class="comment"># mini-batch index</span></div><div class="line">    train_mb = theano.function(</div><div class="line">        [i], cost, updates=updates,</div><div class="line">        givens=&#123;</div><div class="line">            self.x:</div><div class="line">            training_x[i*self.mini_batch_size: (i+<span class="number">1</span>)*self.mini_batch_size],</div><div class="line">            self.y:</div><div class="line">            training_y[i*self.mini_batch_size: (i+<span class="number">1</span>)*self.mini_batch_size]</div><div class="line">        &#125;)</div><div class="line">    validate_mb_accuracy = theano.function(</div><div class="line">        [i], self.layers[<span class="number">-1</span>].accuracy(self.y),</div><div class="line">        givens=&#123;</div><div class="line">            self.x:</div><div class="line">            validation_x[i*self.mini_batch_size: (i+<span class="number">1</span>)*self.mini_batch_size],</div><div class="line">            self.y:</div><div class="line">            validation_y[i*self.mini_batch_size: (i+<span class="number">1</span>)*self.mini_batch_size]</div><div class="line">        &#125;)</div><div class="line">    test_mb_accuracy = theano.function(</div><div class="line">        [i], self.layers[<span class="number">-1</span>].accuracy(self.y),</div><div class="line">        givens=&#123;</div><div class="line">            self.x:</div><div class="line">            test_x[i*self.mini_batch_size: (i+<span class="number">1</span>)*self.mini_batch_size],</div><div class="line">            self.y:</div><div class="line">            test_y[i*self.mini_batch_size: (i+<span class="number">1</span>)*self.mini_batch_size]</div><div class="line">        &#125;)</div><div class="line">    self.test_mb_predictions = theano.function(</div><div class="line">        [i], self.layers[<span class="number">-1</span>].y_out,</div><div class="line">        givens=&#123;</div><div class="line">            self.x:</div><div class="line">            test_x[i*self.mini_batch_size: (i+<span class="number">1</span>)*self.mini_batch_size]</div><div class="line">        &#125;)</div><div class="line">    <span class="comment"># Do the actual training</span></div><div class="line">    best_validation_accuracy = <span class="number">0.0</span></div><div class="line">    <span class="keyword">for</span> epoch <span class="keyword">in</span> xrange(epochs):</div><div class="line">        <span class="keyword">for</span> minibatch_index <span class="keyword">in</span> xrange(num_training_batches):</div><div class="line">            iteration = num_training_batches*epoch+minibatch_index</div><div class="line">            <span class="keyword">if</span> iteration % <span class="number">1000</span> == <span class="number">0</span>:</div><div class="line">                print(<span class="string">"Training mini-batch number &#123;0&#125;"</span>.format(iteration))</div><div class="line">            cost_ij = train_mb(minibatch_index)</div><div class="line">            <span class="keyword">if</span> (iteration+<span class="number">1</span>) % num_training_batches == <span class="number">0</span>:</div><div class="line">                validation_accuracy = np.mean(</div><div class="line">                    [validate_mb_accuracy(j) <span class="keyword">for</span> j <span class="keyword">in</span> xrange(num_validation_batches)])</div><div class="line">                print(<span class="string">"Epoch &#123;0&#125;: validation accuracy &#123;1:.2%&#125;"</span>.format(</div><div class="line">                    epoch, validation_accuracy))</div><div class="line">                <span class="keyword">if</span> validation_accuracy &gt;= best_validation_accuracy:</div><div class="line">                    print(<span class="string">"This is the best validation accuracy to date."</span>)</div><div class="line">                    best_validation_accuracy = validation_accuracy</div><div class="line">                    best_iteration = iteration</div><div class="line">                    <span class="keyword">if</span> test_data:</div><div class="line">                        test_accuracy = np.mean(</div><div class="line">                            [test_mb_accuracy(j) <span class="keyword">for</span> j <span class="keyword">in</span> xrange(num_test_batches)])</div><div class="line">                        print(<span class="string">'The corresponding test accuracy is &#123;0:.2%&#125;'</span>.format(</div><div class="line">                            test_accuracy))</div><div class="line">    print(<span class="string">"Finished training network."</span>)</div><div class="line">    print(<span class="string">"Best validation accuracy of &#123;0:.2%&#125; obtained at iteration &#123;1&#125;"</span>.format(</div><div class="line">        best_validation_accuracy, best_iteration))</div><div class="line">    print(<span class="string">"Corresponding test accuracy of &#123;0:.2%&#125;"</span>.format(test_accuracy))</div></pre></td></tr></table></figure></p>
<h2 id="正则化和梯度求解"><a href="#正则化和梯度求解" class="headerlink" title="正则化和梯度求解　"></a>正则化和梯度求解　</h2><p>首先求每个迭代期需要计算多少次mini-batch。接着定义正则化代价函数，这里使用的是L2正则化。紧接着定义符号化求梯度方法以及梯度更新方法。具体代码含义如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">grads = T.grad(cost, self.params)<span class="comment">#第一个参数是要求梯度的式子，第二个参数是要对什么参数求梯度</span></div><div class="line">updates = [(param, param-eta*grad) <span class="keyword">for</span> param, grad <span class="keyword">in</span> zip(self.params, grads)]<span class="comment">#更新</span></div></pre></td></tr></table></figure></p>
<p>　　注意上述都是符号化定义，并未实际运行。</p>
<h2 id="训练方法定义"><a href="#训练方法定义" class="headerlink" title="训练方法定义　　"></a>训练方法定义　　</h2><p>　　紧接着定义训练方法，使用theano.function方法。第一个参数是输入，即mini-batch的编号，使用的是long类型，即T.lscalar。第二个参数是返回值，即代价值。其他参数updates定义参数的更新，givens用于提供mini-batch训练数据及分类。<br>　　对于验证方法和测试方法，第一个参数仍然是输入编号，第二个参数是返回值，即正确率，updates参数用于提供mini-batch数据及分类。<br>　　上述都是属于符号化定义。下面开始实际的训练。</p>
<h2 id="实际训练"><a href="#实际训练" class="headerlink" title="实际训练"></a>实际训练</h2><p>　　最外层循环是epoch轮次，再里面一层是每个轮次需要运行的Mini_batch数目。首先，计算目前为止的迭代数，一个mini_batch的计算代表一次迭代。每1000次迭代就输出提示，按照一次训练mini-batch-size=10条数据，1000次迭代就有10000条数据经过了训练。每次训练cost_ij = train_mb(minibatch_index)，都会先进行前向传播计算输出，然后计算代价，进而计算梯度并更新参数。(iteration+1) % num_training_batches == 0代表一次轮次epoch结束。此时对验证集进行验证，验证过程中，会对验证集数据进行前向传播计算输出，具体计算符号定义是在set_inpt中定义的。如果此时验证集准确率比之前轮次的高，则使用得到的模型计算测试集准确率，测试集准确率计算同验证集。<br>　　最后输出最好的结果以及迭代次数。</p>
<h1 id="结果分析"><a href="#结果分析" class="headerlink" title="结果分析"></a>结果分析</h1><h2 id="迭代过程"><a href="#迭代过程" class="headerlink" title="迭代过程"></a>迭代过程</h2><p>　　尝试对比不采取弃权策略和采取弃权策略的结果。<br>　　下面是不采取弃权策略,即p_dropout=0的结果，截取了20个轮次。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div></pre></td><td class="code"><pre><div class="line">Training mini-batch number <span class="number">0</span></div><div class="line">Training mini-batch number <span class="number">1000</span></div><div class="line">Training mini-batch number <span class="number">2000</span></div><div class="line">Training mini-batch number <span class="number">3000</span></div><div class="line">Training mini-batch number <span class="number">4000</span></div><div class="line">Epoch <span class="number">0</span>: validation accuracy <span class="number">93.92</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">93.25</span>%</div><div class="line">Training mini-batch number <span class="number">5000</span></div><div class="line">Training mini-batch number <span class="number">6000</span></div><div class="line">Training mini-batch number <span class="number">7000</span></div><div class="line">Training mini-batch number <span class="number">8000</span></div><div class="line">Training mini-batch number <span class="number">9000</span></div><div class="line">Epoch <span class="number">1</span>: validation accuracy <span class="number">96.26</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">96.03</span>%</div><div class="line">Training mini-batch number <span class="number">10000</span></div><div class="line">Training mini-batch number <span class="number">11000</span></div><div class="line">Training mini-batch number <span class="number">12000</span></div><div class="line">Training mini-batch number <span class="number">13000</span></div><div class="line">Training mini-batch number <span class="number">14000</span></div><div class="line">Epoch <span class="number">2</span>: validation accuracy <span class="number">97.14</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">96.93</span>%</div><div class="line">Training mini-batch number <span class="number">15000</span></div><div class="line">Training mini-batch number <span class="number">16000</span></div><div class="line">Training mini-batch number <span class="number">17000</span></div><div class="line">Training mini-batch number <span class="number">18000</span></div><div class="line">Training mini-batch number <span class="number">19000</span></div><div class="line">Epoch <span class="number">3</span>: validation accuracy <span class="number">97.62</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">97.40</span>%</div><div class="line">Training mini-batch number <span class="number">20000</span></div><div class="line">Training mini-batch number <span class="number">21000</span></div><div class="line">Training mini-batch number <span class="number">22000</span></div><div class="line">Training mini-batch number <span class="number">23000</span></div><div class="line">Training mini-batch number <span class="number">24000</span></div><div class="line">Epoch <span class="number">4</span>: validation accuracy <span class="number">97.88</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">97.73</span>%</div><div class="line">Training mini-batch number <span class="number">25000</span></div><div class="line">Training mini-batch number <span class="number">26000</span></div><div class="line">Training mini-batch number <span class="number">27000</span></div><div class="line">Training mini-batch number <span class="number">28000</span></div><div class="line">Training mini-batch number <span class="number">29000</span></div><div class="line">Epoch <span class="number">5</span>: validation accuracy <span class="number">98.08</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">98.00</span>%</div><div class="line">Training mini-batch number <span class="number">30000</span></div><div class="line">Training mini-batch number <span class="number">31000</span></div><div class="line">Training mini-batch number <span class="number">32000</span></div><div class="line">Training mini-batch number <span class="number">33000</span></div><div class="line">Training mini-batch number <span class="number">34000</span></div><div class="line">Epoch <span class="number">6</span>: validation accuracy <span class="number">98.19</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">98.18</span>%</div><div class="line">Training mini-batch number <span class="number">35000</span></div><div class="line">Training mini-batch number <span class="number">36000</span></div><div class="line">Training mini-batch number <span class="number">37000</span></div><div class="line">Training mini-batch number <span class="number">38000</span></div><div class="line">Training mini-batch number <span class="number">39000</span></div><div class="line">Epoch <span class="number">7</span>: validation accuracy <span class="number">98.28</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">98.25</span>%</div><div class="line">Training mini-batch number <span class="number">40000</span></div><div class="line">Training mini-batch number <span class="number">41000</span></div><div class="line">Training mini-batch number <span class="number">42000</span></div><div class="line">Training mini-batch number <span class="number">43000</span></div><div class="line">Training mini-batch number <span class="number">44000</span></div><div class="line">Epoch <span class="number">8</span>: validation accuracy <span class="number">98.32</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">98.34</span>%</div><div class="line">Training mini-batch number <span class="number">45000</span></div><div class="line">Training mini-batch number <span class="number">46000</span></div><div class="line">Training mini-batch number <span class="number">47000</span></div><div class="line">Training mini-batch number <span class="number">48000</span></div><div class="line">Training mini-batch number <span class="number">49000</span></div><div class="line">Epoch <span class="number">9</span>: validation accuracy <span class="number">98.34</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">98.41</span>%</div><div class="line">Training mini-batch number <span class="number">50000</span></div><div class="line">Training mini-batch number <span class="number">51000</span></div><div class="line">Training mini-batch number <span class="number">52000</span></div><div class="line">Training mini-batch number <span class="number">53000</span></div><div class="line">Training mini-batch number <span class="number">54000</span></div><div class="line">Epoch <span class="number">10</span>: validation accuracy <span class="number">98.42</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">98.45</span>%</div><div class="line">Training mini-batch number <span class="number">55000</span></div><div class="line">Training mini-batch number <span class="number">56000</span></div><div class="line">Training mini-batch number <span class="number">57000</span></div><div class="line">Training mini-batch number <span class="number">58000</span></div><div class="line">Training mini-batch number <span class="number">59000</span></div><div class="line">Epoch <span class="number">11</span>: validation accuracy <span class="number">98.44</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">98.45</span>%</div><div class="line">Training mini-batch number <span class="number">60000</span></div><div class="line">Training mini-batch number <span class="number">61000</span></div><div class="line">Training mini-batch number <span class="number">62000</span></div><div class="line">Training mini-batch number <span class="number">63000</span></div><div class="line">Training mini-batch number <span class="number">64000</span></div><div class="line">Epoch <span class="number">12</span>: validation accuracy <span class="number">98.40</span>%</div><div class="line">Training mini-batch number <span class="number">65000</span></div><div class="line">Training mini-batch number <span class="number">66000</span></div><div class="line">Training mini-batch number <span class="number">67000</span></div><div class="line">Training mini-batch number <span class="number">68000</span></div><div class="line">Training mini-batch number <span class="number">69000</span></div><div class="line">Epoch <span class="number">13</span>: validation accuracy <span class="number">98.44</span>%</div><div class="line">Training mini-batch number <span class="number">70000</span></div><div class="line">Training mini-batch number <span class="number">71000</span></div><div class="line">Training mini-batch number <span class="number">72000</span></div><div class="line">Training mini-batch number <span class="number">73000</span></div><div class="line">Training mini-batch number <span class="number">74000</span></div><div class="line">Epoch <span class="number">14</span>: validation accuracy <span class="number">98.44</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">98.40</span>%</div><div class="line">Training mini-batch number <span class="number">75000</span></div><div class="line">Training mini-batch number <span class="number">76000</span></div><div class="line">Training mini-batch number <span class="number">77000</span></div><div class="line">Training mini-batch number <span class="number">78000</span></div><div class="line">Training mini-batch number <span class="number">79000</span></div><div class="line">Epoch <span class="number">15</span>: validation accuracy <span class="number">98.46</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">98.42</span>%</div><div class="line">Training mini-batch number <span class="number">80000</span></div><div class="line">Training mini-batch number <span class="number">81000</span></div><div class="line">Training mini-batch number <span class="number">82000</span></div><div class="line">Training mini-batch number <span class="number">83000</span></div><div class="line">Training mini-batch number <span class="number">84000</span></div><div class="line">Epoch <span class="number">16</span>: validation accuracy <span class="number">98.48</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">98.42</span>%</div><div class="line">Training mini-batch number <span class="number">85000</span></div><div class="line">Training mini-batch number <span class="number">86000</span></div><div class="line">Training mini-batch number <span class="number">87000</span></div><div class="line">Training mini-batch number <span class="number">88000</span></div><div class="line">Training mini-batch number <span class="number">89000</span></div><div class="line">Epoch <span class="number">17</span>: validation accuracy <span class="number">98.48</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">98.42</span>%</div><div class="line">Training mini-batch number <span class="number">90000</span></div><div class="line">Training mini-batch number <span class="number">91000</span></div><div class="line">Training mini-batch number <span class="number">92000</span></div><div class="line">Training mini-batch number <span class="number">93000</span></div><div class="line">Training mini-batch number <span class="number">94000</span></div><div class="line">Epoch <span class="number">18</span>: validation accuracy <span class="number">98.50</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">98.42</span>%</div><div class="line">Training mini-batch number <span class="number">95000</span></div><div class="line">Training mini-batch number <span class="number">96000</span></div><div class="line">Training mini-batch number <span class="number">97000</span></div><div class="line">Training mini-batch number <span class="number">98000</span></div><div class="line">Training mini-batch number <span class="number">99000</span></div><div class="line">Epoch <span class="number">19</span>: validation accuracy <span class="number">98.51</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">98.43</span>%</div><div class="line">Training mini-batch number <span class="number">100000</span></div><div class="line">Training mini-batch number <span class="number">101000</span></div><div class="line">Training mini-batch number <span class="number">102000</span></div><div class="line">Training mini-batch number <span class="number">103000</span></div><div class="line">Training mini-batch number <span class="number">104000</span></div><div class="line">Epoch <span class="number">20</span>: validation accuracy <span class="number">98.57</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">98.47</span>%</div></pre></td></tr></table></figure></p>
<p>　　下面是采取弃权策略，并设p_dropout=0.3的结果。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div></pre></td><td class="code"><pre><div class="line">Training mini-batch number <span class="number">0</span></div><div class="line">Training mini-batch number <span class="number">1000</span></div><div class="line">Training mini-batch number <span class="number">2000</span></div><div class="line">Training mini-batch number <span class="number">3000</span></div><div class="line">Training mini-batch number <span class="number">4000</span></div><div class="line">Epoch <span class="number">0</span>: validation accuracy <span class="number">93.39</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">92.51</span>%</div><div class="line">Training mini-batch number <span class="number">5000</span></div><div class="line">Training mini-batch number <span class="number">6000</span></div><div class="line">Training mini-batch number <span class="number">7000</span></div><div class="line">Training mini-batch number <span class="number">8000</span></div><div class="line">Training mini-batch number <span class="number">9000</span></div><div class="line">Epoch <span class="number">1</span>: validation accuracy <span class="number">96.30</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">95.87</span>%</div><div class="line">Training mini-batch number <span class="number">10000</span></div><div class="line">Training mini-batch number <span class="number">11000</span></div><div class="line">Training mini-batch number <span class="number">12000</span></div><div class="line">Training mini-batch number <span class="number">13000</span></div><div class="line">Training mini-batch number <span class="number">14000</span></div><div class="line">Epoch <span class="number">2</span>: validation accuracy <span class="number">97.35</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">96.94</span>%</div><div class="line">Training mini-batch number <span class="number">15000</span></div><div class="line">Training mini-batch number <span class="number">16000</span></div><div class="line">Training mini-batch number <span class="number">17000</span></div><div class="line">Training mini-batch number <span class="number">18000</span></div><div class="line">Training mini-batch number <span class="number">19000</span></div><div class="line">Epoch <span class="number">3</span>: validation accuracy <span class="number">97.82</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">97.45</span>%</div><div class="line">Training mini-batch number <span class="number">20000</span></div><div class="line">Training mini-batch number <span class="number">21000</span></div><div class="line">Training mini-batch number <span class="number">22000</span></div><div class="line">Training mini-batch number <span class="number">23000</span></div><div class="line">Training mini-batch number <span class="number">24000</span></div><div class="line">Epoch <span class="number">4</span>: validation accuracy <span class="number">98.14</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">97.93</span>%</div><div class="line">Training mini-batch number <span class="number">25000</span></div><div class="line">Training mini-batch number <span class="number">26000</span></div><div class="line">Training mini-batch number <span class="number">27000</span></div><div class="line">Training mini-batch number <span class="number">28000</span></div><div class="line">Training mini-batch number <span class="number">29000</span></div><div class="line">Epoch <span class="number">5</span>: validation accuracy <span class="number">98.13</span>%</div><div class="line">Training mini-batch number <span class="number">30000</span></div><div class="line">Training mini-batch number <span class="number">31000</span></div><div class="line">Training mini-batch number <span class="number">32000</span></div><div class="line">Training mini-batch number <span class="number">33000</span></div><div class="line">Training mini-batch number <span class="number">34000</span></div><div class="line">Epoch <span class="number">6</span>: validation accuracy <span class="number">98.26</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">98.23</span>%</div><div class="line">Training mini-batch number <span class="number">35000</span></div><div class="line">Training mini-batch number <span class="number">36000</span></div><div class="line">Training mini-batch number <span class="number">37000</span></div><div class="line">Training mini-batch number <span class="number">38000</span></div><div class="line">Training mini-batch number <span class="number">39000</span></div><div class="line">Epoch <span class="number">7</span>: validation accuracy <span class="number">98.56</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">98.48</span>%</div><div class="line">Training mini-batch number <span class="number">40000</span></div><div class="line">Training mini-batch number <span class="number">41000</span></div><div class="line">Training mini-batch number <span class="number">42000</span></div><div class="line">Training mini-batch number <span class="number">43000</span></div><div class="line">Training mini-batch number <span class="number">44000</span></div><div class="line">Epoch <span class="number">8</span>: validation accuracy <span class="number">98.59</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">98.53</span>%</div><div class="line">Training mini-batch number <span class="number">45000</span></div><div class="line">Training mini-batch number <span class="number">46000</span></div><div class="line">Training mini-batch number <span class="number">47000</span></div><div class="line">Training mini-batch number <span class="number">48000</span></div><div class="line">Training mini-batch number <span class="number">49000</span></div><div class="line">Epoch <span class="number">9</span>: validation accuracy <span class="number">98.59</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">98.68</span>%</div><div class="line">Training mini-batch number <span class="number">50000</span></div><div class="line">Training mini-batch number <span class="number">51000</span></div><div class="line">Training mini-batch number <span class="number">52000</span></div><div class="line">Training mini-batch number <span class="number">53000</span></div><div class="line">Training mini-batch number <span class="number">54000</span></div><div class="line">Epoch <span class="number">10</span>: validation accuracy <span class="number">98.72</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">98.78</span>%</div><div class="line">Training mini-batch number <span class="number">55000</span></div><div class="line">Training mini-batch number <span class="number">56000</span></div><div class="line">Training mini-batch number <span class="number">57000</span></div><div class="line">Training mini-batch number <span class="number">58000</span></div><div class="line">Training mini-batch number <span class="number">59000</span></div><div class="line">Epoch <span class="number">11</span>: validation accuracy <span class="number">98.69</span>%</div><div class="line">Training mini-batch number <span class="number">60000</span></div><div class="line">Training mini-batch number <span class="number">61000</span></div><div class="line">Training mini-batch number <span class="number">62000</span></div><div class="line">Training mini-batch number <span class="number">63000</span></div><div class="line">Training mini-batch number <span class="number">64000</span></div><div class="line">Epoch <span class="number">12</span>: validation accuracy <span class="number">98.74</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">98.79</span>%</div><div class="line">Training mini-batch number <span class="number">65000</span></div><div class="line">Training mini-batch number <span class="number">66000</span></div><div class="line">Training mini-batch number <span class="number">67000</span></div><div class="line">Training mini-batch number <span class="number">68000</span></div><div class="line">Training mini-batch number <span class="number">69000</span></div><div class="line">Epoch <span class="number">13</span>: validation accuracy <span class="number">98.72</span>%</div><div class="line">Training mini-batch number <span class="number">70000</span></div><div class="line">Training mini-batch number <span class="number">71000</span></div><div class="line">Training mini-batch number <span class="number">72000</span></div><div class="line">Training mini-batch number <span class="number">73000</span></div><div class="line">Training mini-batch number <span class="number">74000</span></div><div class="line">Epoch <span class="number">14</span>: validation accuracy <span class="number">98.77</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">98.75</span>%</div><div class="line">Training mini-batch number <span class="number">75000</span></div><div class="line">Training mini-batch number <span class="number">76000</span></div><div class="line">Training mini-batch number <span class="number">77000</span></div><div class="line">Training mini-batch number <span class="number">78000</span></div><div class="line">Training mini-batch number <span class="number">79000</span></div><div class="line">Epoch <span class="number">15</span>: validation accuracy <span class="number">98.78</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">98.82</span>%</div><div class="line">Training mini-batch number <span class="number">80000</span></div><div class="line">Training mini-batch number <span class="number">81000</span></div><div class="line">Training mini-batch number <span class="number">82000</span></div><div class="line">Training mini-batch number <span class="number">83000</span></div><div class="line">Training mini-batch number <span class="number">84000</span></div><div class="line">Epoch <span class="number">16</span>: validation accuracy <span class="number">98.87</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">98.95</span>%</div><div class="line">Training mini-batch number <span class="number">85000</span></div><div class="line">Training mini-batch number <span class="number">86000</span></div><div class="line">Training mini-batch number <span class="number">87000</span></div><div class="line">Training mini-batch number <span class="number">88000</span></div><div class="line">Training mini-batch number <span class="number">89000</span></div><div class="line">Epoch <span class="number">17</span>: validation accuracy <span class="number">98.83</span>%</div><div class="line">Training mini-batch number <span class="number">90000</span></div><div class="line">Training mini-batch number <span class="number">91000</span></div><div class="line">Training mini-batch number <span class="number">92000</span></div><div class="line">Training mini-batch number <span class="number">93000</span></div><div class="line">Training mini-batch number <span class="number">94000</span></div><div class="line">Epoch <span class="number">18</span>: validation accuracy <span class="number">98.77</span>%</div><div class="line">Training mini-batch number <span class="number">95000</span></div><div class="line">Training mini-batch number <span class="number">96000</span></div><div class="line">Training mini-batch number <span class="number">97000</span></div><div class="line">Training mini-batch number <span class="number">98000</span></div><div class="line">Training mini-batch number <span class="number">99000</span></div><div class="line">Epoch <span class="number">19</span>: validation accuracy <span class="number">98.81</span>%</div><div class="line">Training mini-batch number <span class="number">100000</span></div><div class="line">Training mini-batch number <span class="number">101000</span></div><div class="line">Training mini-batch number <span class="number">102000</span></div><div class="line">Training mini-batch number <span class="number">103000</span></div><div class="line">Training mini-batch number <span class="number">104000</span></div><div class="line">Epoch <span class="number">20</span>: validation accuracy <span class="number">98.79</span>%</div><div class="line">Training mini-batch number <span class="number">105000</span></div><div class="line">Training mini-batch number <span class="number">106000</span></div><div class="line">Training mini-batch number <span class="number">107000</span></div><div class="line">Training mini-batch number <span class="number">108000</span></div><div class="line">Training mini-batch number <span class="number">109000</span></div><div class="line">Epoch <span class="number">21</span>: validation accuracy <span class="number">98.82</span>%</div><div class="line">Training mini-batch number <span class="number">110000</span></div><div class="line">Training mini-batch number <span class="number">111000</span></div><div class="line">Training mini-batch number <span class="number">112000</span></div><div class="line">Training mini-batch number <span class="number">113000</span></div><div class="line">Training mini-batch number <span class="number">114000</span></div><div class="line">Epoch <span class="number">22</span>: validation accuracy <span class="number">98.91</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">99.00</span>%</div><div class="line">Training mini-batch number <span class="number">115000</span></div><div class="line">Training mini-batch number <span class="number">116000</span></div><div class="line">Training mini-batch number <span class="number">117000</span></div><div class="line">Training mini-batch number <span class="number">118000</span></div><div class="line">Training mini-batch number <span class="number">119000</span></div><div class="line">Epoch <span class="number">23</span>: validation accuracy <span class="number">98.88</span>%</div><div class="line">Training mini-batch number <span class="number">120000</span></div><div class="line">Training mini-batch number <span class="number">121000</span></div><div class="line">Training mini-batch number <span class="number">122000</span></div><div class="line">Training mini-batch number <span class="number">123000</span></div><div class="line">Training mini-batch number <span class="number">124000</span></div><div class="line">Epoch <span class="number">24</span>: validation accuracy <span class="number">98.92</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">98.93</span>%</div><div class="line">Training mini-batch number <span class="number">125000</span></div><div class="line">Training mini-batch number <span class="number">126000</span></div><div class="line">Training mini-batch number <span class="number">127000</span></div><div class="line">Training mini-batch number <span class="number">128000</span></div><div class="line">Training mini-batch number <span class="number">129000</span></div><div class="line">Epoch <span class="number">25</span>: validation accuracy <span class="number">98.94</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">98.92</span>%</div><div class="line">Training mini-batch number <span class="number">130000</span></div><div class="line">Training mini-batch number <span class="number">131000</span></div><div class="line">Training mini-batch number <span class="number">132000</span></div><div class="line">Training mini-batch number <span class="number">133000</span></div><div class="line">Training mini-batch number <span class="number">134000</span></div><div class="line">Epoch <span class="number">26</span>: validation accuracy <span class="number">98.87</span>%</div><div class="line">Training mini-batch number <span class="number">135000</span></div><div class="line">Training mini-batch number <span class="number">136000</span></div><div class="line">Training mini-batch number <span class="number">137000</span> </div><div class="line">Training mini-batch number <span class="number">138000</span></div><div class="line">Training mini-batch number <span class="number">139000</span></div><div class="line">Epoch <span class="number">27</span>: validation accuracy <span class="number">98.83</span>%</div><div class="line">Training mini-batch number <span class="number">140000</span></div><div class="line">Training mini-batch number <span class="number">141000</span></div><div class="line">Training mini-batch number <span class="number">142000</span></div><div class="line">Training mini-batch number <span class="number">143000</span></div><div class="line">Training mini-batch number <span class="number">144000</span></div><div class="line">Epoch <span class="number">28</span>: validation accuracy <span class="number">98.88</span>%</div><div class="line">Training mini-batch number <span class="number">145000</span></div><div class="line">Training mini-batch number <span class="number">146000</span></div><div class="line">Training mini-batch number <span class="number">147000</span></div><div class="line">Training mini-batch number <span class="number">148000</span></div><div class="line">Training mini-batch number <span class="number">149000</span></div><div class="line">Epoch <span class="number">29</span>: validation accuracy <span class="number">98.91</span>%</div><div class="line">Training mini-batch number <span class="number">150000</span></div><div class="line">Training mini-batch number <span class="number">151000</span></div><div class="line">Training mini-batch number <span class="number">152000</span></div><div class="line">Training mini-batch number <span class="number">153000</span></div><div class="line">Training mini-batch number <span class="number">154000</span></div><div class="line">Epoch <span class="number">30</span>: validation accuracy <span class="number">98.91</span>%</div></pre></td></tr></table></figure></p>
<p>　　可以发现，刚开始的时候，不采取弃权策略的结果更好。但是随着轮次的增加，采取弃权策略的结果马上就超过了不采取弃权策略的结果，并且采取弃权策略的准确率提升也更快。例如在弃权策略中第16轮次测试集准确率就达到了98.95%，而不采取弃权策略，在更多的第20轮次的测试集结果反而才98.47%。<br>　　可以看到弃权策略最优结果为第22轮次的99%。<br>　　实际上可以通过再插入一个卷积层，实现准确率进一步提升到99.22%，如下代码：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">net = Network([</div><div class="line">    ConvPoolLayer(image_shape=(mini_batch_size, <span class="number">1</span>, <span class="number">28</span>, <span class="number">28</span>),</div><div class="line">                filter_shape=(<span class="number">20</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">5</span>),poolsize=(<span class="number">2</span>, <span class="number">2</span>)),</div><div class="line">    ConvPoolLayer(image_shape=(mini_batch_size, <span class="number">20</span>, <span class="number">12</span>, <span class="number">12</span>),</div><div class="line">                filter_shape=(<span class="number">40</span>, <span class="number">20</span>, <span class="number">5</span>, <span class="number">5</span>),poolsize=(<span class="number">2</span>, <span class="number">2</span>)),</div><div class="line">    FullyConnectedLayer(n_in=<span class="number">40</span>*<span class="number">4</span>*<span class="number">4</span>, n_out=<span class="number">100</span>,p_dropout=<span class="number">0.3</span>),</div><div class="line">    SoftmaxLayer(n_in=<span class="number">100</span>, n_out=<span class="number">10</span>)], mini_batch_size)</div><div class="line">net.SGD(training_data, <span class="number">60</span>, mini_batch_size, <span class="number">0.1</span>,validation_data, test_data)</div></pre></td></tr></table></figure></p>
<p>　　具体结果:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div></pre></td><td class="code"><pre><div class="line">Training mini-batch number <span class="number">0</span></div><div class="line">Training mini-batch number <span class="number">1000</span></div><div class="line">Training mini-batch number <span class="number">2000</span></div><div class="line">Training mini-batch number <span class="number">3000</span></div><div class="line">Training mini-batch number <span class="number">4000</span></div><div class="line">Epoch <span class="number">0</span>: validation accuracy <span class="number">88.52</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">88.12</span>%</div><div class="line">Training mini-batch number <span class="number">5000</span></div><div class="line">Training mini-batch number <span class="number">6000</span></div><div class="line">Training mini-batch number <span class="number">7000</span></div><div class="line">Training mini-batch number <span class="number">8000</span></div><div class="line">Training mini-batch number <span class="number">9000</span></div><div class="line">Epoch <span class="number">1</span>: validation accuracy <span class="number">96.09</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">96.08</span>%</div><div class="line">Training mini-batch number <span class="number">10000</span></div><div class="line">Training mini-batch number <span class="number">11000</span></div><div class="line">Training mini-batch number <span class="number">12000</span></div><div class="line">Training mini-batch number <span class="number">13000</span></div><div class="line">Training mini-batch number <span class="number">14000</span></div><div class="line">Epoch <span class="number">2</span>: validation accuracy <span class="number">97.53</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">97.25</span>%</div><div class="line">Training mini-batch number <span class="number">15000</span></div><div class="line">Training mini-batch number <span class="number">16000</span></div><div class="line">Training mini-batch number <span class="number">17000</span></div><div class="line">Training mini-batch number <span class="number">18000</span></div><div class="line">Training mini-batch number <span class="number">19000</span></div><div class="line">Epoch <span class="number">3</span>: validation accuracy <span class="number">97.80</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">97.73</span>%</div><div class="line">Training mini-batch number <span class="number">20000</span></div><div class="line">Training mini-batch number <span class="number">21000</span></div><div class="line">Training mini-batch number <span class="number">22000</span></div><div class="line">Training mini-batch number <span class="number">23000</span></div><div class="line">Training mini-batch number <span class="number">24000</span></div><div class="line">Epoch <span class="number">4</span>: validation accuracy <span class="number">98.09</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">98.11</span>%</div><div class="line">Training mini-batch number <span class="number">25000</span></div><div class="line">Training mini-batch number <span class="number">26000</span></div><div class="line">Training mini-batch number <span class="number">27000</span></div><div class="line">Training mini-batch number <span class="number">28000</span></div><div class="line">Training mini-batch number <span class="number">29000</span></div><div class="line">Epoch <span class="number">5</span>: validation accuracy <span class="number">98.36</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">98.43</span>%</div><div class="line">Training mini-batch number <span class="number">30000</span></div><div class="line">Training mini-batch number <span class="number">31000</span></div><div class="line">Training mini-batch number <span class="number">32000</span></div><div class="line">Training mini-batch number <span class="number">33000</span></div><div class="line">Training mini-batch number <span class="number">34000</span></div><div class="line">Epoch <span class="number">6</span>: validation accuracy <span class="number">98.38</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">98.38</span>%</div><div class="line">Training mini-batch number <span class="number">35000</span></div><div class="line">Training mini-batch number <span class="number">36000</span></div><div class="line">Training mini-batch number <span class="number">37000</span></div><div class="line">Training mini-batch number <span class="number">38000</span></div><div class="line">Training mini-batch number <span class="number">39000</span></div><div class="line">Epoch <span class="number">7</span>: validation accuracy <span class="number">98.50</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">98.63</span>%</div><div class="line">Training mini-batch number <span class="number">40000</span></div><div class="line">Training mini-batch number <span class="number">41000</span></div><div class="line">Training mini-batch number <span class="number">42000</span></div><div class="line">Training mini-batch number <span class="number">43000</span></div><div class="line">Training mini-batch number <span class="number">44000</span></div><div class="line">Epoch <span class="number">8</span>: validation accuracy <span class="number">98.71</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">98.83</span>%</div><div class="line">Training mini-batch number <span class="number">45000</span></div><div class="line">Training mini-batch number <span class="number">46000</span></div><div class="line">Training mini-batch number <span class="number">47000</span></div><div class="line">Training mini-batch number <span class="number">48000</span></div><div class="line">Training mini-batch number <span class="number">49000</span></div><div class="line">Epoch <span class="number">9</span>: validation accuracy <span class="number">98.75</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">98.77</span>%</div><div class="line">Training mini-batch number <span class="number">50000</span></div><div class="line">Training mini-batch number <span class="number">51000</span></div><div class="line">Training mini-batch number <span class="number">52000</span></div><div class="line">Training mini-batch number <span class="number">53000</span></div><div class="line">Training mini-batch number <span class="number">54000</span></div><div class="line">Epoch <span class="number">10</span>: validation accuracy <span class="number">98.64</span>%</div><div class="line">Training mini-batch number <span class="number">55000</span></div><div class="line">Training mini-batch number <span class="number">56000</span></div><div class="line">Training mini-batch number <span class="number">57000</span></div><div class="line">Training mini-batch number <span class="number">58000</span></div><div class="line">Training mini-batch number <span class="number">59000</span></div><div class="line">Epoch <span class="number">11</span>: validation accuracy <span class="number">98.79</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">98.86</span>%</div><div class="line">Training mini-batch number <span class="number">60000</span></div><div class="line">Training mini-batch number <span class="number">61000</span></div><div class="line">Training mini-batch number <span class="number">62000</span></div><div class="line">Training mini-batch number <span class="number">63000</span></div><div class="line">Training mini-batch number <span class="number">64000</span></div><div class="line">Epoch <span class="number">12</span>: validation accuracy <span class="number">98.89</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">99.00</span>%</div><div class="line">Training mini-batch number <span class="number">65000</span></div><div class="line">Training mini-batch number <span class="number">66000</span></div><div class="line">Training mini-batch number <span class="number">67000</span></div><div class="line">Training mini-batch number <span class="number">68000</span></div><div class="line">Training mini-batch number <span class="number">69000</span></div><div class="line">Epoch <span class="number">13</span>: validation accuracy <span class="number">98.82</span>%</div><div class="line">Training mini-batch number <span class="number">70000</span></div><div class="line">Training mini-batch number <span class="number">71000</span></div><div class="line">Training mini-batch number <span class="number">72000</span></div><div class="line">Training mini-batch number <span class="number">73000</span></div><div class="line">Training mini-batch number <span class="number">74000</span></div><div class="line">Epoch <span class="number">14</span>: validation accuracy <span class="number">98.84</span>%</div><div class="line">Training mini-batch number <span class="number">75000</span></div><div class="line">Training mini-batch number <span class="number">76000</span></div><div class="line">Training mini-batch number <span class="number">77000</span></div><div class="line">Training mini-batch number <span class="number">78000</span></div><div class="line">Training mini-batch number <span class="number">79000</span></div><div class="line">Epoch <span class="number">15</span>: validation accuracy <span class="number">98.86</span>%</div><div class="line">Training mini-batch number <span class="number">80000</span></div><div class="line">Training mini-batch number <span class="number">81000</span></div><div class="line">Training mini-batch number <span class="number">82000</span></div><div class="line">Training mini-batch number <span class="number">83000</span></div><div class="line">Training mini-batch number <span class="number">84000</span></div><div class="line">Epoch <span class="number">16</span>: validation accuracy <span class="number">98.95</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">99.05</span>%</div><div class="line">Training mini-batch number <span class="number">85000</span></div><div class="line">Training mini-batch number <span class="number">86000</span></div><div class="line">Training mini-batch number <span class="number">87000</span></div><div class="line">Training mini-batch number <span class="number">88000</span></div><div class="line">Training mini-batch number <span class="number">89000</span></div><div class="line">Epoch <span class="number">17</span>: validation accuracy <span class="number">99.01</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">99.10</span>%</div><div class="line">Training mini-batch number <span class="number">90000</span></div><div class="line">Training mini-batch number <span class="number">91000</span></div><div class="line">Training mini-batch number <span class="number">92000</span></div><div class="line">Training mini-batch number <span class="number">93000</span></div><div class="line">Training mini-batch number <span class="number">94000</span></div><div class="line">Epoch <span class="number">18</span>: validation accuracy <span class="number">98.98</span>%</div><div class="line">Training mini-batch number <span class="number">95000</span></div><div class="line">Training mini-batch number <span class="number">96000</span></div><div class="line">Training mini-batch number <span class="number">97000</span></div><div class="line">Training mini-batch number <span class="number">98000</span></div><div class="line">Training mini-batch number <span class="number">99000</span></div><div class="line">Epoch <span class="number">19</span>: validation accuracy <span class="number">99.02</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">98.99</span>%</div><div class="line">Training mini-batch number <span class="number">100000</span></div><div class="line">Training mini-batch number <span class="number">101000</span></div><div class="line">Training mini-batch number <span class="number">102000</span></div><div class="line">Training mini-batch number <span class="number">103000</span></div><div class="line">Training mini-batch number <span class="number">104000</span></div><div class="line">Epoch <span class="number">20</span>: validation accuracy <span class="number">99.04</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">99.08</span>%</div><div class="line">Training mini-batch number <span class="number">105000</span></div><div class="line">Training mini-batch number <span class="number">106000</span></div><div class="line">Training mini-batch number <span class="number">107000</span></div><div class="line">Training mini-batch number <span class="number">108000</span></div><div class="line">Training mini-batch number <span class="number">109000</span></div><div class="line">Epoch <span class="number">21</span>: validation accuracy <span class="number">99.00</span>%</div><div class="line">Training mini-batch number <span class="number">110000</span></div><div class="line">Training mini-batch number <span class="number">111000</span></div><div class="line">Training mini-batch number <span class="number">112000</span></div><div class="line">Training mini-batch number <span class="number">113000</span></div><div class="line">Training mini-batch number <span class="number">114000</span></div><div class="line">Epoch <span class="number">22</span>: validation accuracy <span class="number">99.05</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">99.07</span>%</div><div class="line">Training mini-batch number <span class="number">115000</span></div><div class="line">Training mini-batch number <span class="number">116000</span></div><div class="line">Training mini-batch number <span class="number">117000</span></div><div class="line">Training mini-batch number <span class="number">118000</span></div><div class="line">Training mini-batch number <span class="number">119000</span></div><div class="line">Epoch <span class="number">23</span>: validation accuracy <span class="number">98.97</span>%</div><div class="line">Training mini-batch number <span class="number">120000</span></div><div class="line">Training mini-batch number <span class="number">121000</span></div><div class="line">Training mini-batch number <span class="number">122000</span></div><div class="line">Training mini-batch number <span class="number">123000</span></div><div class="line">Training mini-batch number <span class="number">124000</span></div><div class="line">Epoch <span class="number">24</span>: validation accuracy <span class="number">99.07</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">99.02</span>%</div><div class="line">Training mini-batch number <span class="number">125000</span></div><div class="line">Training mini-batch number <span class="number">126000</span></div><div class="line">Training mini-batch number <span class="number">127000</span></div><div class="line">Training mini-batch number <span class="number">128000</span></div><div class="line">Training mini-batch number <span class="number">129000</span></div><div class="line">Epoch <span class="number">25</span>: validation accuracy <span class="number">99.03</span>%</div><div class="line">Training mini-batch number <span class="number">130000</span></div><div class="line">Training mini-batch number <span class="number">131000</span></div><div class="line">Training mini-batch number <span class="number">132000</span></div><div class="line">Training mini-batch number <span class="number">133000</span></div><div class="line">Training mini-batch number <span class="number">134000</span></div><div class="line">Epoch <span class="number">26</span>: validation accuracy <span class="number">98.99</span>%</div><div class="line">Training mini-batch number <span class="number">135000</span></div><div class="line">Training mini-batch number <span class="number">136000</span></div><div class="line">Training mini-batch number <span class="number">137000</span></div><div class="line">Training mini-batch number <span class="number">138000</span></div><div class="line">Training mini-batch number <span class="number">139000</span> </div><div class="line">Epoch <span class="number">27</span>: validation accuracy <span class="number">98.97</span>%</div><div class="line">Training mini-batch number <span class="number">140000</span></div><div class="line">Training mini-batch number <span class="number">141000</span></div><div class="line">Training mini-batch number <span class="number">142000</span></div><div class="line">Training mini-batch number <span class="number">143000</span></div><div class="line">Training mini-batch number <span class="number">144000</span></div><div class="line">Epoch <span class="number">28</span>: validation accuracy <span class="number">99.12</span>%</div><div class="line">This <span class="keyword">is</span> the best validation accuracy to date.</div><div class="line">The corresponding test accuracy <span class="keyword">is</span> <span class="number">99.22</span>%</div><div class="line">Training mini-batch number <span class="number">145000</span></div><div class="line">Training mini-batch number <span class="number">146000</span></div><div class="line">Training mini-batch number <span class="number">147000</span></div><div class="line">Training mini-batch number <span class="number">148000</span></div><div class="line">Training mini-batch number <span class="number">149000</span></div><div class="line">Epoch <span class="number">29</span>: validation accuracy <span class="number">99.01</span>%</div><div class="line">Training mini-batch number <span class="number">150000</span></div><div class="line">Training mini-batch number <span class="number">151000</span></div><div class="line">Training mini-batch number <span class="number">152000</span></div><div class="line">Training mini-batch number <span class="number">153000</span></div><div class="line">Training mini-batch number <span class="number">154000</span></div><div class="line">Epoch <span class="number">30</span>: validation accuracy <span class="number">99.01</span>%</div><div class="line">Training mini-batch number <span class="number">155000</span></div><div class="line">Training mini-batch number <span class="number">156000</span></div><div class="line">Training mini-batch number <span class="number">157000</span></div><div class="line">Training mini-batch number <span class="number">158000</span></div><div class="line">Training mini-batch number <span class="number">159000</span></div><div class="line">Epoch <span class="number">31</span>: validation accuracy <span class="number">99.09</span>%</div><div class="line">Training mini-batch number <span class="number">160000</span></div><div class="line">Training mini-batch number <span class="number">161000</span></div><div class="line">Training mini-batch number <span class="number">162000</span></div><div class="line">Training mini-batch number <span class="number">163000</span></div><div class="line">Training mini-batch number <span class="number">164000</span></div><div class="line">Epoch <span class="number">32</span>: validation accuracy <span class="number">99.08</span>%</div><div class="line">Training mini-batch number <span class="number">165000</span></div><div class="line">Training mini-batch number <span class="number">166000</span></div><div class="line">Training mini-batch number <span class="number">167000</span></div><div class="line">Training mini-batch number <span class="number">168000</span></div><div class="line">Training mini-batch number <span class="number">169000</span></div><div class="line">Epoch <span class="number">33</span>: validation accuracy <span class="number">99.04</span>%</div><div class="line">Training mini-batch number <span class="number">170000</span></div><div class="line">Training mini-batch number <span class="number">171000</span></div><div class="line">Training mini-batch number <span class="number">172000</span></div><div class="line">Training mini-batch number <span class="number">173000</span></div><div class="line">Training mini-batch number <span class="number">174000</span></div><div class="line">Epoch <span class="number">34</span>: validation accuracy <span class="number">99.06</span>%</div><div class="line">Training mini-batch number <span class="number">175000</span></div><div class="line">Training mini-batch number <span class="number">176000</span></div><div class="line">Training mini-batch number <span class="number">177000</span></div><div class="line">Training mini-batch number <span class="number">178000</span></div><div class="line">Training mini-batch number <span class="number">179000</span></div><div class="line">Epoch <span class="number">35</span>: validation accuracy <span class="number">99.08</span>%</div><div class="line">Training mini-batch number <span class="number">180000</span></div><div class="line">Training mini-batch number <span class="number">181000</span></div><div class="line">Training mini-batch number <span class="number">182000</span></div><div class="line">Training mini-batch number <span class="number">183000</span></div><div class="line">Training mini-batch number <span class="number">184000</span></div><div class="line">Epoch <span class="number">36</span>: validation accuracy <span class="number">99.09</span>%</div><div class="line">Training mini-batch number <span class="number">185000</span></div><div class="line">Training mini-batch number <span class="number">186000</span></div><div class="line">Training mini-batch number <span class="number">187000</span></div><div class="line">Training mini-batch number <span class="number">188000</span></div><div class="line">Training mini-batch number <span class="number">189000</span></div><div class="line">Epoch <span class="number">37</span>: validation accuracy <span class="number">99.07</span>%</div><div class="line">Training mini-batch number <span class="number">190000</span></div></pre></td></tr></table></figure></p>
<p>　　可以看到，第28 Epoch的时候，测试集准确率达到最高的99.22%。<br>　　后面，我闲暇之余又进行了更多次的迭代，测试集准确率最终在68 epoch时达到了<strong>99.30%</strong>。</p>
<h2 id="可视化"><a href="#可视化" class="headerlink" title="可视化"></a>可视化</h2><p>　　本部分将挑选出10000条测试集数据中被误分类的数字进行可视化，选择的分类模型是使用弃权策略并且包含一个卷积层、一个全连接层、一个柔性最大值输出层的神经网络结构，测试集准确率达到90%。因此10000条测试集中有100条数据被误分类。可视化代码如下，该部分代码根据示例代码进行改造得到：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_error_locations</span><span class="params">(net, test_data)</span>:</span></div><div class="line">    test_x, test_y = test_data</div><div class="line"></div><div class="line">    i = T.lscalar()  <span class="comment"># mini-batch index</span></div><div class="line">    net.test_mb_predictions = theano.function(</div><div class="line">        [i], net.layers[<span class="number">-1</span>].y_out,</div><div class="line">        givens=&#123;</div><div class="line">            net.x:</div><div class="line">                test_x[i * net.mini_batch_size: (i + <span class="number">1</span>) * net.mini_batch_size]</div><div class="line">        &#125;)</div><div class="line">    test_predictions = list(np.concatenate(</div><div class="line">        [net.test_mb_predictions(i) <span class="keyword">for</span> i <span class="keyword">in</span> xrange(size(test_data)/net.mini_batch_size)]))</div><div class="line"></div><div class="line">    test_y_eval = test_y.eval()</div><div class="line"></div><div class="line">    error_locations = [j <span class="keyword">for</span> j <span class="keyword">in</span> xrange(len(test_y_eval))</div><div class="line">                       <span class="keyword">if</span> test_predictions[j] != test_y_eval[j]]</div><div class="line"></div><div class="line">    erroneous_predictions = [test_predictions[j]</div><div class="line">                             <span class="keyword">for</span> j <span class="keyword">in</span> error_locations]</div><div class="line">    <span class="keyword">return</span> error_locations, erroneous_predictions</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">plot_errors</span><span class="params">(error_locations, erroneous_predictions=None, test_data=None)</span>:</span></div><div class="line">    test_x, test_y = test_data[<span class="number">0</span>].eval(), test_data[<span class="number">1</span>].eval()</div><div class="line">    fig = plt.figure()</div><div class="line">    error_images = [np.array(test_x[i]).reshape(<span class="number">28</span>, <span class="number">-1</span>) <span class="keyword">for</span> i <span class="keyword">in</span> error_locations]</div><div class="line">    row,col = <span class="number">12</span>,<span class="number">10</span></div><div class="line">    n = min(row*col, len(error_locations))</div><div class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(n):</div><div class="line">        ax = plt.subplot2grid((row, col), (j/col, j % col))</div><div class="line">        ax.matshow(error_images[j], cmap = matplotlib.cm.binary)</div><div class="line">        ax.text(<span class="number">24</span>, <span class="number">5</span>, test_y[error_locations[j]])</div><div class="line">        <span class="keyword">if</span> erroneous_predictions:</div><div class="line">            ax.text(<span class="number">24</span>, <span class="number">24</span>, erroneous_predictions[j])</div><div class="line">        plt.xticks(np.array([]))</div><div class="line">        plt.yticks(np.array([]))</div><div class="line">    plt.tight_layout()</div><div class="line">    plt.show()</div><div class="line"></div><div class="line"><span class="comment"># draw</span></div><div class="line">error_locations, erroneous_predictions = get_error_locations(net, test_data)</div><div class="line">plot_errors(error_locations, erroneous_predictions,test_data)</div></pre></td></tr></table></figure></p>
<p>　　得到下图：<br><img src="/picture/machine-learning/cnn_error_digits.png" alt="cnn_error_digits"><br>　　如图是误分类的数字，每个数字的右上角是真实的分类，右下角是模型预测的分类。我们可以观察下这100个数字，有些数字即使是我们自己去分类，也很难分辨出来，确实很模棱两可，甚至有些分类我们更认同模型的结果。比如，第一行第8个数，我更认为是9而不是4;第一行第9个数，长得更像9而不是8。因此模型的输出很大程度上是可以接受的。<br>　　更进一步，我使用上述两层卷积结构的神经网络达到的99.30%测试集准确率模型，进行了一次绘图，得到下图，只有70个误分类的数字：<br><img src="/picture/machine-learning/cnn_error_digits_double_conv.png" alt="cnn_error_digits_double_conv"><br>　　我们可以对比一下上面两幅图，看看哪些之前误分类的数字，双层卷积神经网络进行了正确的识别。</p>
<h2 id="保存和加载模型"><a href="#保存和加载模型" class="headerlink" title="保存和加载模型"></a>保存和加载模型</h2><p>　　根据训练过程，我们可以知道上述过程是非常缓慢的。为了测试方便，我们不希望每次都要重新进行训练。因此需要找一个保存和加载模型的方法，这也是书上课后的一个小作业。具体代码如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> cPickle</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">save</span><span class="params">(layers, filename=<span class="string">"../model/params.pkl"</span>)</span>:</span></div><div class="line">    save_file = open(filename, <span class="string">'wb'</span>)  <span class="comment"># this will overwrite current contents</span></div><div class="line">    <span class="keyword">for</span> layer <span class="keyword">in</span> layers:</div><div class="line">        cPickle.dump(layer.w.get_value(borrow=<span class="keyword">True</span>), save_file, <span class="number">-1</span>)</div><div class="line">        cPickle.dump(layer.b.get_value(borrow=<span class="keyword">True</span>), save_file, <span class="number">-1</span>)</div><div class="line">    save_file.close()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">load</span><span class="params">(layers, filename=<span class="string">"../model/params.pkl"</span>)</span>:</span></div><div class="line">    save_file = open(filename,<span class="string">'rb'</span>)</div><div class="line">    <span class="keyword">for</span> layer <span class="keyword">in</span> layers:</div><div class="line">        w_param = cPickle.load(save_file)</div><div class="line">        b_param = cPickle.load(save_file)</div><div class="line">        layer.w.set_value(w_param, borrow=<span class="keyword">True</span>)</div><div class="line">        layer.b.set_value(b_param, borrow=<span class="keyword">True</span>)</div><div class="line">    save_file.close()</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#load(net.layers)#加载模型</span></div><div class="line"><span class="comment">#save(net.layers)#保存模型</span></div></pre></td></tr></table></figure></p>
<p>　　这里有个保存模型小小的技巧。如果不想在所有迭代都跑完才进行模型保存的话，可以使用该技巧在任意迭代期手动进行模型的保存。这里针对的是使用pycharm进行python代码coding的同学，可以直接debug整个程序，开始时忽略断点直接运行，然后在你感觉某个epoch后，模型的结果不错的时候，想保存下模型，那么可以打开断点，使程序暂时停止执行，然后使用evaluate expression(alt+F8)功能，直接调用save(net.layers,”../model/param-epoch-轮次数-准确率.pkl”)进行模型的保存。当然，也可以直接写代码，让结果超过你的预期性能的时候，自动进行保存也是可以的。<br>　　这样，只需要简单的修改下SGD方法，当模型是从文件中加载进来的时候，就不需要进行迭代训练，直接进行结果的预测即可。修改过的完整代码如下。</p>
<h1 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div></pre></td><td class="code"><pre><div class="line"><span class="string">"""network3.py</span></div><div class="line">~~~~~~~~~~~~~~</div><div class="line"></div><div class="line">A Theano-based program for training and running simple neural</div><div class="line">networks.</div><div class="line"></div><div class="line">Supports several layer types (fully connected, convolutional, max</div><div class="line">pooling, softmax), and activation functions (sigmoid, tanh, and</div><div class="line">rectified linear units, with more easily added).</div><div class="line"></div><div class="line">When run on a CPU, this program is much faster than network.py and</div><div class="line">network2.py.  However, unlike network.py and network2.py it can also</div><div class="line">be run on a GPU, which makes it faster still.</div><div class="line"></div><div class="line">Because the code is based on Theano, the code is different in many</div><div class="line">ways from network.py and network2.py.  However, where possible I have</div><div class="line">tried to maintain consistency with the earlier programs.  In</div><div class="line">particular, the API is similar to network2.py.  Note that I have</div><div class="line">focused on making the code simple, easily readable, and easily</div><div class="line">modifiable.  It is not optimized, and omits many desirable features.</div><div class="line"></div><div class="line">This program incorporates ideas from the Theano documentation on</div><div class="line">convolutional neural nets (notably,</div><div class="line">http://deeplearning.net/tutorial/lenet.html ), from Misha Denil's</div><div class="line">implementation of dropout (https://github.com/mdenil/dropout ), and</div><div class="line">from Chris Olah (http://colah.github.io ).</div><div class="line"></div><div class="line">Written for Theano 0.6 and 0.7, needs some changes for more recent</div><div class="line">versions of Theano.</div><div class="line"></div><div class="line">"""</div><div class="line"></div><div class="line"><span class="comment">#### Libraries</span></div><div class="line"><span class="comment"># Standard library</span></div><div class="line"><span class="keyword">import</span> cPickle</div><div class="line"><span class="keyword">import</span> gzip</div><div class="line"></div><div class="line"><span class="comment"># Third-party libraries</span></div><div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line"><span class="keyword">import</span> theano</div><div class="line"><span class="keyword">import</span> theano.tensor <span class="keyword">as</span> T</div><div class="line"><span class="keyword">from</span> theano.tensor.nnet <span class="keyword">import</span> conv</div><div class="line"><span class="keyword">from</span> theano.tensor.nnet <span class="keyword">import</span> softmax</div><div class="line"><span class="keyword">from</span> theano.tensor <span class="keyword">import</span> shared_randomstreams</div><div class="line"><span class="keyword">from</span> theano.tensor.signal <span class="keyword">import</span> pool</div><div class="line"></div><div class="line"><span class="comment"># Activation functions for neurons</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">linear</span><span class="params">(z)</span>:</span> <span class="keyword">return</span> z</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">ReLU</span><span class="params">(z)</span>:</span> <span class="keyword">return</span> T.maximum(<span class="number">0.0</span>, z)</div><div class="line"><span class="keyword">from</span> theano.tensor.nnet <span class="keyword">import</span> sigmoid</div><div class="line"><span class="keyword">from</span> theano.tensor <span class="keyword">import</span> tanh</div><div class="line"><span class="keyword">import</span> matplotlib</div><div class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</div><div class="line"><span class="comment">#import seaborn as sns</span></div><div class="line"><span class="keyword">import</span> cPickle</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#### Constants</span></div><div class="line">GPU = <span class="keyword">False</span></div><div class="line"><span class="keyword">if</span> GPU:</div><div class="line">    <span class="keyword">print</span> <span class="string">"Trying to run under a GPU.  If this is not desired, then modify "</span>+\</div><div class="line">        <span class="string">"network3.py\nto set the GPU flag to False."</span></div><div class="line">    <span class="keyword">try</span>: theano.config.device = <span class="string">'gpu'</span></div><div class="line">    <span class="keyword">except</span>: <span class="keyword">pass</span> <span class="comment"># it's already set</span></div><div class="line">    theano.config.floatX = <span class="string">'float32'</span></div><div class="line"><span class="keyword">else</span>:</div><div class="line">    <span class="keyword">print</span> <span class="string">"Running with a CPU.  If this is not desired, then the modify "</span>+\</div><div class="line">        <span class="string">"network3.py to set\nthe GPU flag to True."</span></div><div class="line"></div><div class="line"><span class="comment">#### Load the MNIST data</span></div><div class="line"><span class="function"><span class="keyword">def</span>  <span class="title">load_data_shared</span><span class="params">(filename=<span class="string">"../data/mnist.pkl.gz"</span>)</span>:</span></div><div class="line">    f = gzip.open(filename, <span class="string">'rb'</span>)</div><div class="line">    training_data, validation_data, test_data = cPickle.load(f)</div><div class="line">    <span class="keyword">print</span> <span class="string">"test len:"</span>,len(test_data[<span class="number">0</span>])</div><div class="line">    f.close()</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">shared</span><span class="params">(data)</span>:</span></div><div class="line">        <span class="string">"""Place the data into shared variables.  This allows Theano to copy</span></div><div class="line">        the data to the GPU, if one is available.</div><div class="line"></div><div class="line">        """</div><div class="line">        shared_x = theano.shared(</div><div class="line">            np.asarray(data[<span class="number">0</span>], dtype=theano.config.floatX), borrow=<span class="keyword">True</span>)</div><div class="line">        shared_y = theano.shared(</div><div class="line">            np.asarray(data[<span class="number">1</span>], dtype=theano.config.floatX), borrow=<span class="keyword">True</span>)</div><div class="line">        <span class="keyword">return</span> shared_x, T.cast(shared_y, <span class="string">"int32"</span>)</div><div class="line">    <span class="keyword">return</span> [shared(training_data), shared(validation_data), shared(test_data)]</div><div class="line"></div><div class="line"><span class="comment">#### Main class used to construct and train networks</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Network</span><span class="params">(object)</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, layers, mini_batch_size)</span>:</span></div><div class="line">        <span class="string">"""Takes a list of `layers`, describing the network architecture, and</span></div><div class="line">        a value for the `mini_batch_size` to be used during training</div><div class="line">        by stochastic gradient descent.</div><div class="line"></div><div class="line">        """</div><div class="line">        self.layers = layers</div><div class="line">        self.mini_batch_size = mini_batch_size</div><div class="line">        self.params = [param <span class="keyword">for</span> layer <span class="keyword">in</span> self.layers <span class="keyword">for</span> param <span class="keyword">in</span> layer.params]</div><div class="line">        self.x = T.matrix(<span class="string">"x"</span>)</div><div class="line">        self.y = T.ivector(<span class="string">"y"</span>)</div><div class="line">        init_layer = self.layers[<span class="number">0</span>]</div><div class="line">        init_layer.set_inpt(self.x, self.x, self.mini_batch_size)</div><div class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> xrange(<span class="number">1</span>, len(self.layers)):</div><div class="line">            prev_layer, layer  = self.layers[j<span class="number">-1</span>], self.layers[j]</div><div class="line">            layer. set_inpt(</div><div class="line">                prev_layer.output, prev_layer.output_dropout, self.mini_batch_size)</div><div class="line">        self.output = self.layers[<span class="number">-1</span>].output</div><div class="line">        self.output_dropout = self.layers[<span class="number">-1</span>].output_dropout</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">SGD</span><span class="params">(self, training_data, epochs, mini_batch_size, eta,</span></span></div><div class="line">            validation_data, test_data, lmbda=<span class="number">0.0</span>, is_load_model_from_file=False):</div><div class="line">        <span class="string">"""Train the network using mini-batch stochastic gradient descent."""</span></div><div class="line">        training_x, training_y = training_data</div><div class="line">        validation_x, validation_y = validation_data</div><div class="line">        test_x, test_y = test_data</div><div class="line"></div><div class="line">        <span class="comment"># compute number of minibatches for training, validation and testing</span></div><div class="line">        num_training_batches = size(training_data)/mini_batch_size</div><div class="line">        num_validation_batches = size(validation_data)/mini_batch_size</div><div class="line">        num_test_batches = size(test_data)/mini_batch_size</div><div class="line"></div><div class="line">        <span class="comment"># define the (regularized) cost function, symbolic gradients, and updates</span></div><div class="line">        l2_norm_squared = sum([(layer.w**<span class="number">2</span>).sum() <span class="keyword">for</span> layer <span class="keyword">in</span> self.layers])</div><div class="line">        cost = self.layers[<span class="number">-1</span>].cost(self)+\</div><div class="line">               <span class="number">0.5</span>*lmbda*l2_norm_squared/num_training_batches</div><div class="line">        grads = T.grad(cost, self.params)</div><div class="line">        updates = [(param, param-eta*grad)</div><div class="line">                   <span class="keyword">for</span> param, grad <span class="keyword">in</span> zip(self.params, grads)]</div><div class="line"></div><div class="line">        <span class="comment"># define functions to train a mini-batch, and to compute the</span></div><div class="line">        <span class="comment"># accuracy in validation and test mini-batches.</span></div><div class="line">        i = T.lscalar() <span class="comment"># mini-batch index</span></div><div class="line">        train_mb = theano.function(</div><div class="line">            [i], cost, updates=updates,</div><div class="line">            givens=&#123;</div><div class="line">                self.x:</div><div class="line">                training_x[i*self.mini_batch_size: (i+<span class="number">1</span>)*self.mini_batch_size],</div><div class="line">                self.y:</div><div class="line">                training_y[i*self.mini_batch_size: (i+<span class="number">1</span>)*self.mini_batch_size]</div><div class="line">            &#125;)</div><div class="line">        validate_mb_accuracy = theano.function(</div><div class="line">            [i], self.layers[<span class="number">-1</span>].accuracy(self.y),</div><div class="line">            givens=&#123;</div><div class="line">                self.x:</div><div class="line">                validation_x[i*self.mini_batch_size: (i+<span class="number">1</span>)*self.mini_batch_size],</div><div class="line">                self.y:</div><div class="line">                validation_y[i*self.mini_batch_size: (i+<span class="number">1</span>)*self.mini_batch_size]</div><div class="line">            &#125;)</div><div class="line">        test_mb_accuracy = theano.function(</div><div class="line">            [i], self.layers[<span class="number">-1</span>].accuracy(self.y),</div><div class="line">            givens=&#123;</div><div class="line">                self.x:</div><div class="line">                test_x[i*self.mini_batch_size: (i+<span class="number">1</span>)*self.mini_batch_size],</div><div class="line">                self.y:</div><div class="line">                test_y[i*self.mini_batch_size: (i+<span class="number">1</span>)*self.mini_batch_size]</div><div class="line">            &#125;)</div><div class="line">        self.test_mb_predictions = theano.function(</div><div class="line">            [i], self.layers[<span class="number">-1</span>].y_out,</div><div class="line">            givens=&#123;</div><div class="line">                self.x:</div><div class="line">                test_x[i*self.mini_batch_size: (i+<span class="number">1</span>)*self.mini_batch_size]</div><div class="line">            &#125;)</div><div class="line"></div><div class="line">        <span class="comment"># Load model from file</span></div><div class="line">        <span class="keyword">if</span> is_load_model_from_file:</div><div class="line">            <span class="keyword">print</span> <span class="string">'use the model loaded from file...'</span></div><div class="line">            test_accuracy = np.mean(</div><div class="line">                [test_mb_accuracy(j) <span class="keyword">for</span> j <span class="keyword">in</span> xrange(num_test_batches)])</div><div class="line">            print(<span class="string">'The corresponding test accuracy is &#123;0:.2%&#125;'</span>.format(</div><div class="line">                test_accuracy))</div><div class="line"></div><div class="line">        <span class="comment"># Do the actual training</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">print</span> <span class="string">"begin training..."</span></div><div class="line">            best_validation_accuracy = <span class="number">0.0</span></div><div class="line">            <span class="keyword">for</span> epoch <span class="keyword">in</span> xrange(epochs):</div><div class="line">                <span class="keyword">for</span> minibatch_index <span class="keyword">in</span> xrange(num_training_batches):</div><div class="line">                    iteration = num_training_batches * epoch + minibatch_index</div><div class="line">                    <span class="keyword">if</span> iteration % <span class="number">1000</span> == <span class="number">0</span>:</div><div class="line">                        print(<span class="string">"Training mini-batch number &#123;0&#125;"</span>.format(iteration))</div><div class="line">                    cost_ij = train_mb(minibatch_index)</div><div class="line">                    <span class="keyword">if</span> (iteration + <span class="number">1</span>) % num_training_batches == <span class="number">0</span>:</div><div class="line">                        validation_accuracy = np.mean(</div><div class="line">                            [validate_mb_accuracy(j) <span class="keyword">for</span> j <span class="keyword">in</span> xrange(num_validation_batches)])</div><div class="line">                        print(<span class="string">"Epoch &#123;0&#125;: validation accuracy &#123;1:.2%&#125;"</span>.format(</div><div class="line">                            epoch, validation_accuracy))</div><div class="line">                        <span class="keyword">if</span> validation_accuracy &gt;= best_validation_accuracy:</div><div class="line">                            print(<span class="string">"This is the best validation accuracy to date."</span>)</div><div class="line">                            best_validation_accuracy = validation_accuracy</div><div class="line">                            best_iteration = iteration</div><div class="line">                            <span class="keyword">if</span> test_data:</div><div class="line">                                test_accuracy = np.mean(</div><div class="line">                                    [test_mb_accuracy(j) <span class="keyword">for</span> j <span class="keyword">in</span> xrange(num_test_batches)])</div><div class="line">                                print(<span class="string">'The corresponding test accuracy is &#123;0:.2%&#125;'</span>.format(</div><div class="line">                                    test_accuracy))</div><div class="line">            print(<span class="string">"Finished training network."</span>)</div><div class="line">            print(<span class="string">"Best validation accuracy of &#123;0:.2%&#125; obtained at iteration &#123;1&#125;"</span>.format(</div><div class="line">                best_validation_accuracy, best_iteration))</div><div class="line">            print(<span class="string">"Corresponding test accuracy of &#123;0:.2%&#125;"</span>.format(test_accuracy))</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#### Define layer types</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConvPoolLayer</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="string">"""Used to create a combination of a convolutional and a max-pooling</span></div><div class="line">    layer.  A more sophisticated implementation would separate the</div><div class="line">    two, but for our purposes we'll always use them together, and it</div><div class="line">    simplifies the code, so it makes sense to combine them.</div><div class="line"></div><div class="line">    """</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, filter_shape, image_shape, poolsize=<span class="params">(<span class="number">2</span>, <span class="number">2</span>)</span>,</span></span></div><div class="line">                 activation_fn=sigmoid):</div><div class="line">        <span class="string">"""`filter_shape` is a tuple of length 4, whose entries are the number</span></div><div class="line">        of filters, the number of input feature maps, the filter height, and the</div><div class="line">        filter width.</div><div class="line"></div><div class="line">        `image_shape` is a tuple of length 4, whose entries are the</div><div class="line">        mini-batch size, the number of input feature maps, the image</div><div class="line">        height, and the image width.</div><div class="line"></div><div class="line">        `poolsize` is a tuple of length 2, whose entries are the y and</div><div class="line">        x pooling sizes.</div><div class="line"></div><div class="line">        """</div><div class="line">        self.filter_shape = filter_shape</div><div class="line">        self.image_shape = image_shape</div><div class="line">        self.poolsize = poolsize</div><div class="line">        self.activation_fn=activation_fn</div><div class="line">        <span class="comment"># initialize weights and biases</span></div><div class="line">        n_out = (filter_shape[<span class="number">0</span>]*np.prod(filter_shape[<span class="number">2</span>:])/np.prod(poolsize))</div><div class="line">        self.w = theano.shared(</div><div class="line">            np.asarray(</div><div class="line">                np.random.normal(loc=<span class="number">0</span>, scale=np.sqrt(<span class="number">1.0</span>/n_out), size=filter_shape),</div><div class="line">                dtype=theano.config.floatX),</div><div class="line">            borrow=<span class="keyword">True</span>)</div><div class="line">        self.b = theano.shared(</div><div class="line">            np.asarray(</div><div class="line">                np.random.normal(loc=<span class="number">0</span>, scale=<span class="number">1.0</span>, size=(filter_shape[<span class="number">0</span>],)),</div><div class="line">                dtype=theano.config.floatX),</div><div class="line">            borrow=<span class="keyword">True</span>)</div><div class="line">        self.params = [self.w, self.b]</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_inpt</span><span class="params">(self, inpt, inpt_dropout, mini_batch_size)</span>:</span></div><div class="line">        self.inpt = inpt.reshape(self.image_shape)</div><div class="line">        conv_out = conv.conv2d(</div><div class="line">            input=self.inpt, filters=self.w, filter_shape=self.filter_shape,</div><div class="line">            image_shape=self.image_shape)</div><div class="line">        pooled_out = pool.pool_2d(</div><div class="line">            input=conv_out, ds=self.poolsize, ignore_border=<span class="keyword">True</span>, mode=<span class="string">'max'</span>)</div><div class="line">        self.output = self.activation_fn(</div><div class="line">            pooled_out + self.b.dimshuffle(<span class="string">'x'</span>, <span class="number">0</span>, <span class="string">'x'</span>, <span class="string">'x'</span>))</div><div class="line">        self.output_dropout = self.output <span class="comment"># no dropout in the convolutional layers</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">FullyConnectedLayer</span><span class="params">(object)</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, n_in, n_out, activation_fn=sigmoid, p_dropout=<span class="number">0.0</span>)</span>:</span></div><div class="line">        self.n_in = n_in</div><div class="line">        self.n_out = n_out</div><div class="line">        self.activation_fn = activation_fn</div><div class="line">        self.p_dropout = p_dropout</div><div class="line">        <span class="comment"># Initialize weights and biases</span></div><div class="line">        self.w = theano.shared(</div><div class="line">            np.asarray(</div><div class="line">                np.random.normal(</div><div class="line">                    loc=<span class="number">0.0</span>, scale=np.sqrt(<span class="number">1.0</span>/n_out), size=(n_in, n_out)),</div><div class="line">                dtype=theano.config.floatX),</div><div class="line">            name=<span class="string">'w'</span>, borrow=<span class="keyword">True</span>)</div><div class="line">        self.b = theano.shared(</div><div class="line">            np.asarray(np.random.normal(loc=<span class="number">0.0</span>, scale=<span class="number">1.0</span>, size=(n_out,)),</div><div class="line">                       dtype=theano.config.floatX),</div><div class="line">            name=<span class="string">'b'</span>, borrow=<span class="keyword">True</span>)</div><div class="line">        self.params = [self.w, self.b]</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_inpt</span><span class="params">(self, inpt, inpt_dropout, mini_batch_size)</span>:</span></div><div class="line">        self.inpt = inpt.reshape((mini_batch_size, self.n_in))</div><div class="line">        self.output = self.activation_fn(</div><div class="line">            (<span class="number">1</span>-self.p_dropout)*T.dot(self.inpt, self.w) + self.b)</div><div class="line">        self.y_out = T.argmax(self.output, axis=<span class="number">1</span>)</div><div class="line">        self.inpt_dropout = dropout_layer(</div><div class="line">            inpt_dropout.reshape((mini_batch_size, self.n_in)), self.p_dropout)</div><div class="line">        self.output_dropout = self.activation_fn(</div><div class="line">            T.dot(self.inpt_dropout, self.w) + self.b)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">accuracy</span><span class="params">(self, y)</span>:</span></div><div class="line">        <span class="string">"Return the accuracy for the mini-batch."</span></div><div class="line">        <span class="keyword">return</span> T.mean(T.eq(y, self.y_out))</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SoftmaxLayer</span><span class="params">(object)</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, n_in, n_out, p_dropout=<span class="number">0.0</span>)</span>:</span></div><div class="line">        self.n_in = n_in</div><div class="line">        self.n_out = n_out</div><div class="line">        self.p_dropout = p_dropout</div><div class="line">        <span class="comment"># Initialize weights and biases</span></div><div class="line">        self.w = theano.shared(</div><div class="line">            np.zeros((n_in, n_out), dtype=theano.config.floatX),</div><div class="line">            name=<span class="string">'w'</span>, borrow=<span class="keyword">True</span>)</div><div class="line">        self.b = theano.shared(</div><div class="line">            np.zeros((n_out,), dtype=theano.config.floatX),</div><div class="line">            name=<span class="string">'b'</span>, borrow=<span class="keyword">True</span>)</div><div class="line">        self.params = [self.w, self.b]</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_inpt</span><span class="params">(self, inpt, inpt_dropout, mini_batch_size)</span>:</span></div><div class="line">        self.inpt = inpt.reshape((mini_batch_size, self.n_in))</div><div class="line">        self.output = softmax((<span class="number">1</span>-self.p_dropout)*T.dot(self.inpt, self.w) + self.b)</div><div class="line">        self.y_out = T.argmax(self.output, axis=<span class="number">1</span>)</div><div class="line">        self.inpt_dropout = dropout_layer(</div><div class="line">            inpt_dropout.reshape((mini_batch_size, self.n_in)), self.p_dropout)</div><div class="line">        self.output_dropout = softmax(T.dot(self.inpt_dropout, self.w) + self.b)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cost</span><span class="params">(self, net)</span>:</span></div><div class="line">        <span class="string">"Return the log-likelihood cost."</span></div><div class="line">        <span class="keyword">return</span> -T.mean(T.log(self.output_dropout)[T.arange(net.y.shape[<span class="number">0</span>]), net.y])</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">accuracy</span><span class="params">(self, y)</span>:</span></div><div class="line">        <span class="string">"Return the accuracy for the mini-batch."</span></div><div class="line">        <span class="keyword">return</span> T.mean(T.eq(y, self.y_out))</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#### Miscellanea</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">size</span><span class="params">(data)</span>:</span></div><div class="line">    <span class="string">"Return the size of the dataset `data`."</span></div><div class="line">    <span class="keyword">return</span> data[<span class="number">0</span>].get_value(borrow=<span class="keyword">True</span>).shape[<span class="number">0</span>]</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">dropout_layer</span><span class="params">(layer, p_dropout)</span>:</span></div><div class="line">    srng = shared_randomstreams.RandomStreams(</div><div class="line">        np.random.RandomState(<span class="number">0</span>).randint(<span class="number">999999</span>))</div><div class="line">    mask = srng.binomial(n=<span class="number">1</span>, p=<span class="number">1</span>-p_dropout, size=layer.shape)</div><div class="line">    <span class="keyword">return</span> layer*T.cast(mask, theano.config.floatX)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_error_locations</span><span class="params">(net, test_data)</span>:</span></div><div class="line">    test_x, test_y = test_data</div><div class="line"></div><div class="line">    i = T.lscalar()  <span class="comment"># mini-batch index</span></div><div class="line">    net.test_mb_predictions = theano.function(</div><div class="line">        [i], net.layers[<span class="number">-1</span>].y_out,</div><div class="line">        givens=&#123;</div><div class="line">            net.x:</div><div class="line">                test_x[i * net.mini_batch_size: (i + <span class="number">1</span>) * net.mini_batch_size]</div><div class="line">        &#125;)</div><div class="line">    test_predictions = list(np.concatenate(</div><div class="line">        [net.test_mb_predictions(i) <span class="keyword">for</span> i <span class="keyword">in</span> xrange(size(test_data)/net.mini_batch_size)]))</div><div class="line"></div><div class="line">    test_y_eval = test_y.eval()</div><div class="line"></div><div class="line">    error_locations = [j <span class="keyword">for</span> j <span class="keyword">in</span> xrange(len(test_y_eval))</div><div class="line">                       <span class="keyword">if</span> test_predictions[j] != test_y_eval[j]]</div><div class="line"></div><div class="line">    erroneous_predictions = [test_predictions[j]</div><div class="line">                             <span class="keyword">for</span> j <span class="keyword">in</span> error_locations]</div><div class="line"></div><div class="line">    <span class="keyword">return</span> error_locations, erroneous_predictions</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">plot_errors</span><span class="params">(error_locations, erroneous_predictions=None, test_data=None)</span>:</span></div><div class="line">    test_x, test_y = test_data[<span class="number">0</span>].eval(), test_data[<span class="number">1</span>].eval()</div><div class="line">    fig = plt.figure()</div><div class="line">    error_images = [np.array(test_x[i]).reshape(<span class="number">28</span>, <span class="number">-1</span>) <span class="keyword">for</span> i <span class="keyword">in</span> error_locations]</div><div class="line">    row,col = <span class="number">12</span>,<span class="number">10</span></div><div class="line">    n = min(row*col, len(error_locations))</div><div class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(n):</div><div class="line">        ax = plt.subplot2grid((row, col), (j/col, j % col))</div><div class="line">        ax.matshow(error_images[j], cmap = matplotlib.cm.binary)</div><div class="line">        ax.text(<span class="number">24</span>, <span class="number">5</span>, test_y[error_locations[j]])</div><div class="line">        <span class="keyword">if</span> erroneous_predictions:</div><div class="line">            ax.text(<span class="number">24</span>, <span class="number">24</span>, erroneous_predictions[j])</div><div class="line">        plt.xticks(np.array([]))</div><div class="line">        plt.yticks(np.array([]))</div><div class="line">    plt.tight_layout()</div><div class="line">    plt.show()</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">save</span><span class="params">(layers, filename=<span class="string">"../model/params.pkl"</span>)</span>:</span></div><div class="line">    save_file = open(filename, <span class="string">'wb'</span>)  <span class="comment"># this will overwrite current contents</span></div><div class="line">    <span class="keyword">for</span> layer <span class="keyword">in</span> layers:</div><div class="line">        cPickle.dump(layer.w.get_value(borrow=<span class="keyword">True</span>), save_file, <span class="number">-1</span>)</div><div class="line">        cPickle.dump(layer.b.get_value(borrow=<span class="keyword">True</span>), save_file, <span class="number">-1</span>)</div><div class="line">    save_file.close()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">load</span><span class="params">(layers, filename=<span class="string">"../model/params.pkl"</span>)</span>:</span></div><div class="line">    save_file = open(filename,<span class="string">'rb'</span>)</div><div class="line">    <span class="keyword">for</span> layer <span class="keyword">in</span> layers:</div><div class="line">        w_param = cPickle.load(save_file)</div><div class="line">        b_param = cPickle.load(save_file)</div><div class="line">        layer.w.set_value(w_param, borrow=<span class="keyword">True</span>)</div><div class="line">        layer.b.set_value(b_param, borrow=<span class="keyword">True</span>)</div><div class="line">    save_file.close()</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># running</span></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</div><div class="line">    is_load_model_from_file = <span class="keyword">False</span></div><div class="line"></div><div class="line">    training_data, validation_data, test_data = load_data_shared()</div><div class="line">    mini_batch_size = <span class="number">10</span></div><div class="line">    net = Network(</div><div class="line">         [ConvPoolLayer(image_shape=(mini_batch_size, <span class="number">1</span>, <span class="number">28</span>, <span class="number">28</span>), filter_shape=(<span class="number">20</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">5</span>), poolsize=(<span class="number">2</span>, <span class="number">2</span>)),</div><div class="line">            FullyConnectedLayer(n_in=<span class="number">20</span> * <span class="number">12</span> * <span class="number">12</span>, n_out=<span class="number">100</span>, p_dropout=<span class="number">0.3</span>),</div><div class="line">            SoftmaxLayer(n_in=<span class="number">100</span>, n_out=<span class="number">10</span>)], mini_batch_size)</div><div class="line"></div><div class="line">    <span class="keyword">if</span> is_load_model_from_file:</div><div class="line">        load(net.layers)</div><div class="line"></div><div class="line">    net.SGD(training_data, <span class="number">30</span>, mini_batch_size, <span class="number">0.1</span>, validation_data, test_data, is_load_model_from_file=is_load_model_from_file)</div><div class="line"></div><div class="line">    <span class="comment"># if training,then save model</span></div><div class="line">    <span class="keyword">if</span> is_load_model_from_file == <span class="keyword">False</span>:</div><div class="line">        save(net.layers)</div><div class="line"></div><div class="line">    <span class="comment"># draw error classification digits</span></div><div class="line">    error_locations, erroneous_predictions=get_error_locations(net, test_data)</div><div class="line">    plot_errors(error_locations, erroneous_predictions,test_data)</div></pre></td></tr></table></figure>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="http://neuralnetworksanddeeplearning.com/chap6.html" target="_blank" rel="external">神经网络和深度学习入门</a><br><a href="http://deeplearning.net/software/theano/" target="_blank" rel="external">Theano教程</a></p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        
  <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
    <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
    <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
      <span>赏</span>
    </button>
    <div id="QR" style="display: none;">
      
        <div id="wechat" style="display: inline-block">
          <img id="wechat_qr" src="/picture/wechatpay.JPG" alt="xuetf WeChat Pay"/>
          <p>微信打赏</p>
        </div>
      
      
        <div id="alipay" style="display: inline-block">
          <img id="alipay_qr" src="/picture/alipay.JPG" alt="xuetf Alipay"/>
          <p>支付宝打赏</p>
        </div>
      
    </div>
  </div>


      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/神经网络/" rel="tag"># 神经网络</a>
          
            <a href="/tags/深度学习/" rel="tag"># 深度学习</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/08/08/feedforward-neural-network-handwritten/" rel="next" title="前馈神经网络实践">
                <i class="fa fa-chevron-left"></i> 前馈神经网络实践
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
         <div id="uyan_frame"></div>
    
  </div>

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="https://avatars1.githubusercontent.com/u/11912425?v=3&u=11f9f5dc75aaf84f020a06c0b9cb2b6f401c586b&s=400"
               alt="xuetf" />
          <p class="site-author-name" itemprop="name">xuetf</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">28</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">9</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">63</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              链接
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://lsxj615.com/" title="小王子" target="_blank">小王子</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://github.com/xuetf/" title="My Github" target="_blank">My Github</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Theano安装"><span class="nav-number">1.</span> <span class="nav-text">Theano安装</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Anaconda"><span class="nav-number">1.1.</span> <span class="nav-text">Anaconda</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MinGW"><span class="nav-number">1.2.</span> <span class="nav-text">MinGW</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Theano"><span class="nav-number">1.3.</span> <span class="nav-text">Theano</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#数据集加载"><span class="nav-number">2.</span> <span class="nav-text">数据集加载</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#卷积神经网络结构"><span class="nav-number">3.</span> <span class="nav-text">卷积神经网络结构</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#运行代码"><span class="nav-number">4.</span> <span class="nav-text">运行代码</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#卷积层和混合层"><span class="nav-number">5.</span> <span class="nav-text">卷积层和混合层</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#初始化"><span class="nav-number">5.1.</span> <span class="nav-text">初始化　　</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#卷积操作"><span class="nav-number">5.2.</span> <span class="nav-text">卷积操作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#池化操作"><span class="nav-number">5.3.</span> <span class="nav-text">池化操作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#激活操作"><span class="nav-number">5.4.</span> <span class="nav-text">激活操作　</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#全连接层"><span class="nav-number">6.</span> <span class="nav-text">全连接层</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#初始化-1"><span class="nav-number">6.1.</span> <span class="nav-text">初始化　</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#dropout弃权"><span class="nav-number">6.2.</span> <span class="nav-text">dropout弃权</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#输出层"><span class="nav-number">7.</span> <span class="nav-text">输出层</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#柔性最大值"><span class="nav-number">7.1.</span> <span class="nav-text">柔性最大值</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#对数似然代价函数"><span class="nav-number">7.2.</span> <span class="nav-text">对数似然代价函数</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Network初始化"><span class="nav-number">8.</span> <span class="nav-text">Network初始化</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#学习算法"><span class="nav-number">9.</span> <span class="nav-text">学习算法</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#正则化和梯度求解"><span class="nav-number">9.1.</span> <span class="nav-text">正则化和梯度求解　</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#训练方法定义"><span class="nav-number">9.2.</span> <span class="nav-text">训练方法定义　　</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实际训练"><span class="nav-number">9.3.</span> <span class="nav-text">实际训练</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#结果分析"><span class="nav-number">10.</span> <span class="nav-text">结果分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#迭代过程"><span class="nav-number">10.1.</span> <span class="nav-text">迭代过程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#可视化"><span class="nav-number">10.2.</span> <span class="nav-text">可视化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#保存和加载模型"><span class="nav-number">10.3.</span> <span class="nav-text">保存和加载模型</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#完整代码"><span class="nav-number">11.</span> <span class="nav-text">完整代码</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考"><span class="nav-number">12.</span> <span class="nav-text">参考</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">xuetf</span>
</div>




<script type="text/x-mathjax-config">
 MathJax.Hub.Config({"HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"], linebreaks: { automatic:true }, EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50) },
 tex2jax: { inlineMath: [ ["$", "$"], ["\\(","\\)"] ], processEscapes: true, ignoreClass: "tex2jax_ignore|dno",skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']},
 TeX: { noUndefined: { attributes: { mathcolor: "red", mathbackground: "#FFEEEE", mathsize: "90%" } }, Macros: { href: "{}" } },
 messageStyle: "none"
 });
</script>
<script type="text/x-mathjax-config">
 MathJax.Hub.Queue(function() {
 var all = MathJax.Hub.getAllJax(), i;
 for(i=0; i < all.length; i += 1) {
 all[i].SourceElement().parentNode.className += ' has-jax';
 }
 });
</script>
<script type="text/x-mathjax-config">
 MathJax.Hub.Queue(function() {
 var all = MathJax.Hub.getAllJax(), i;
 for(i=0; i < all.length; i += 1) {
 all[i].SourceElement().parentNode.className += ' has-jax';
 }
 });
</script>
<script charset="utf-8" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        

<div class="busuanzi-count">

  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv"><i class="fa fa-user"></i><span class="busuanzi-value" id="busuanzi_value_site_uv"></span></span>
  

  
    <span class="site-pv"><i class="fa fa-eye"></i><span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span>
  
  
</div>



        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  



  
    
  
 
      <!-- UY BEGIN -->
      <script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=2122877"></script>
      <!-- UY END -->
  



	





  




  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();
    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = $( "entry", xmlResponse ).map(function() {
            return {
              title: $( "title", this ).text(),
              content: $("content",this).text(),
              url: $( "url" , this).text()
            };
          }).get();
          var $input = document.getElementById(search_id);
          var $resultContent = document.getElementById(content_id);
          $input.addEventListener('input', function(){
            var matchcounts = 0;
            var str='<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length > 1) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var content_index = [];
                var data_title = data.title.trim().toLowerCase();
                var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                var data_url = decodeURIComponent(data.url);
                var index_title = -1;
                var index_content = -1;
                var first_occur = -1;
                // only match artiles with not empty titles and contents
                if(data_title != '') {
                  keywords.forEach(function(keyword, i) {
                    index_title = data_title.indexOf(keyword);
                    index_content = data_content.indexOf(keyword);
                    if( index_title >= 0 || index_content >= 0 ){
                      isMatch = true;
                      if (i == 0) {
                        first_occur = index_content;
                      }
                    }

                  });
                }
                // show search results
                if (isMatch) {
                  matchcounts += 1;
                  str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                  var content = data.content.trim().replace(/<[^>]+>/g,"");
                  if (first_occur >= 0) {
                    // cut out 100 characters
                    var start = first_occur - 20;
                    var end = first_occur + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if(start == 0){
                      end = 50;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    var match_content = content.substring(start, end);
                    // highlight all keywords
                    keywords.forEach(function(keyword){
                      var regS = new RegExp(keyword, "gi");
                      match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                    });

                    str += "<p class=\"search-result\">" + match_content +"...</p>"
                  }
                  str += "</li>";
                }
              })};
            str += "</ul>";
            if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
            if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
            $resultContent.innerHTML = str;
          });
          proceedsearch();
        }
      });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  

  <!-- custom analytics part create by xiamo -->
<script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
<script>AV.initialize("DFlRFg5OyISCpmUurUC3Vk4s-gzGzoHsz", "0ayDjXz6ELVOVmPMjLQH3llQ");</script>
<script>
function showTime(Counter) {
  var query = new AV.Query(Counter);
  $(".leancloud_visitors").each(function() {
    var url = $(this).attr("id").trim();
    query.equalTo("url", url);
    query.find({
      success: function(results) {
        if (results.length == 0) {
          var content = '0 ' + $(document.getElementById(url)).text();
          $(document.getElementById(url)).text(content);
          return;
        }
        for (var i = 0; i < results.length; i++) {
          var object = results[i];
          var content = object.get('time') + ' ' + $(document.getElementById(url)).text();
          $(document.getElementById(url)).text(content);
        }
      },
      error: function(object, error) {
        console.log("Error: " + error.code + " " + error.message);
      }
    });

  });
}

function addCount(Counter) {
  var Counter = AV.Object.extend("Counter");
  url = $(".leancloud_visitors").attr('id').trim();
  title = $(".leancloud_visitors").attr('data-flag-title').trim();
  var query = new AV.Query(Counter);
  query.equalTo("url", url);
  query.find({
    success: function(results) {
      if (results.length > 0) {
        var counter = results[0];
        counter.fetchWhenSave(true);
        counter.increment("time");
        counter.save(null, {
          success: function(counter) {
            var content =  counter.get('time') + ' ' + $(document.getElementById(url)).text();
            $(document.getElementById(url)).text(content);
          },
          error: function(counter, error) {
            console.log('Failed to save Visitor num, with error message: ' + error.message);
          }
        });
      } else {
        var newcounter = new Counter();
        newcounter.set("title", title);
        newcounter.set("url", url);
        newcounter.set("time", 1);
        newcounter.save(null, {
          success: function(newcounter) {
              console.log("newcounter.get('time')="+newcounter.get('time'));
            var content = newcounter.get('time') + ' ' + $(document.getElementById(url)).text();
            $(document.getElementById(url)).text(content);
          },
          error: function(newcounter, error) {
            console.log('Failed to create');
          }
        });
      }
    },
    error: function(error) {
      console.log('Error:' + error.code + " " + error.message);
    }
  });
}
$(function() {
  var Counter = AV.Object.extend("Counter");
  if ($('.leancloud_visitors').length == 1) {
    addCount(Counter);
  } else if ($('.post-title-link').length > 1) {
    showTime(Counter);
  }
}); 
</script>
  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  


</body>
</html>
